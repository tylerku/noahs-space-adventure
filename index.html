<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Noah's Space Adventure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #220000; font-family: 'Arial', sans-serif; }

        /* HUD UI */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.5s ease-in-out;
        }

        /* Top Bar: Repair Progress */
        .top-hud { text-align: center; }
        .repair-label { color: #00ffff; font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; margin-bottom: 5px; }
        .progress-container {
            width: 400px; height: 20px; background: rgba(0,0,0,0.7);
            border: 2px solid #00ffff; margin: 0 auto; border-radius: 10px; overflow: hidden;
        }
        #repair-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00ffff, #0099ff); transition: width 0.2s; }

        /* Health Status */
        .status-box { text-align: left; color: white; text-shadow: 2px 2px #000; }
        .hannah-hp { color: #ff99cc; font-size: 24px; font-weight: bold; }

        /* Controls Helper */
        .controls { text-align: center; color: #aaa; font-size: 14px; margin-bottom: 10px; }
        .key { background: #444; color: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #888; }

        /* Game Over / Win Screens */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            text-align: center;
            color: white;
        }
        #overlay h1 { font-size: 60px; margin: 0; }
        #overlay h2 { color: #aaa; margin-top: 10px; }
        #restart-btn {
            margin-top: 20px; padding: 15px 30px; font-size: 20px;
            background: #00ccff; border: none; border-radius: 5px; cursor: pointer; color: #000; font-weight: bold;
        }
        #restart-btn:hover { background: #fff; }

        /* Mission Intro Screen */
        #mission-intro {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a0a0a 0%, #2a1010 50%, #3a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .mission-container {
            text-align: center;
            animation: fadeInUp 1s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mission-label {
            font-size: 24px;
            color: #ff6633;
            text-transform: uppercase;
            letter-spacing: 15px;
            margin-bottom: 20px;
            animation: glitch 2s infinite;
            text-shadow: 0 0 10px #ff6633, 0 0 20px #ff4400, 0 0 30px #cc3300;
        }
        @keyframes glitch {
            0%, 90%, 100% { transform: translateX(0); }
            92% { transform: translateX(-5px); }
            94% { transform: translateX(5px); }
            96% { transform: translateX(-3px); }
            98% { transform: translateX(3px); }
        }
        .mission-number {
            font-size: 120px;
            font-weight: 900;
            color: #ff4422;
            text-shadow: 0 0 20px #ff4422, 0 0 40px #cc3311, 0 0 60px #aa2200;
            margin: -20px 0;
            font-family: 'Impact', sans-serif;
            letter-spacing: -5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .mission-title {
            font-size: 32px;
            color: #ffddcc;
            max-width: 600px;
            line-height: 1.4;
            margin-top: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .mission-title .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
        .scan-line {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, #ff6633, transparent);
            animation: scan 3s linear infinite;
        }
        @keyframes scan {
            from { top: 0; }
            to { top: 100%; }
        }
        .corner-decor {
            position: absolute;
            width: 60px; height: 60px;
            border: 3px solid #ff6633;
        }
        .corner-decor.tl { top: 30px; left: 30px; border-right: none; border-bottom: none; }
        .corner-decor.tr { top: 30px; right: 30px; border-left: none; border-bottom: none; }
        .corner-decor.bl { bottom: 30px; left: 30px; border-right: none; border-top: none; }
        .corner-decor.br { bottom: 30px; right: 30px; border-left: none; border-top: none; }

        /* Cutscene Screen */
        #cutscene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #1a0a0a 0%, #2a1515 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .cutscene-scene {
            width: 700px;
            height: 350px;
            background: linear-gradient(180deg, #3a2020 0%, #5a3030 100%);
            border-radius: 20px;
            border: 4px solid #ff6666;
            box-shadow: 0 0 30px rgba(255,100,100,0.3);
            position: relative;
            overflow: hidden;
        }
        .mars-ground {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 100px;
            background: linear-gradient(180deg, #8B4513 0%, #A0522D 100%);
            border-top: 3px solid #CD853F;
        }
        /* Character Labels */
        .character-label {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 12px;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: labelPulse 2s ease-in-out infinite;
        }
        @keyframes labelPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        .hannah-label {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            top: 20px;
            left: -60px;
            transform: none;
        }
        .james-label {
            background: linear-gradient(135deg, #87CEEB, #4169E1);
            color: white;
            top: -25px;
            left: 85px;
            transform: translateX(-50%);
            font-size: 12px;
            padding: 3px 8px;
        }
        .cutscene-hannah {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            animation: hannahBounce 1s ease-in-out infinite;
        }
        @keyframes hannahBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        .hannah-container {
            position: relative;
            width: 120px;
            height: 140px;
        }
        /* Hannah's Body - Pink dress */
        .hannah-body {
            width: 50px;
            height: 60px;
            background: linear-gradient(180deg, #ff69b4 0%, #ff1493 100%);
            border-radius: 25px 25px 15px 15px;
            position: absolute;
            bottom: 0;
            left: 20px;
            box-shadow: inset -5px 0 10px rgba(0,0,0,0.1);
        }
        /* Dress details */
        .hannah-body::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 5px;
            right: 5px;
            height: 20px;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.2));
            border-radius: 0 0 10px 10px;
        }
        /* Hannah's Head */
        .hannah-head {
            width: 40px;
            height: 45px;
            background: #ffdbac;
            border-radius: 50% 50% 45% 45%;
            position: absolute;
            bottom: 55px;
            left: 25px;
            box-shadow: inset -3px 0 8px rgba(0,0,0,0.1);
        }
        /* Hannah's Hair - Long brown hair */
        .hannah-hair {
            position: absolute;
            bottom: 50px;
            left: 18px;
            width: 55px;
            height: 60px;
            background: #8B4513;
            border-radius: 30px 30px 10px 10px;
            z-index: -1;
        }
        /* Hair bangs */
        .hannah-hair::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 45px;
            height: 20px;
            background: #8B4513;
            border-radius: 50% 50% 0 0;
        }
        /* Hair sides/pigtails */
        .hannah-hair-left, .hannah-hair-right {
            position: absolute;
            width: 15px;
            height: 50px;
            background: #8B4513;
            border-radius: 10px;
            bottom: 30px;
        }
        .hannah-hair-left {
            left: 10px;
        }
        .hannah-hair-right {
            left: 65px;
        }
        /* Hannah's Face Features */
        .hannah-face {
            position: absolute;
            bottom: 60px;
            left: 30px;
            width: 30px;
            height: 30px;
        }
        .hannah-eye {
            width: 8px;
            height: 10px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 8px;
        }
        .hannah-eye::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 6px;
            background: #4a3728;
            border-radius: 50%;
            top: 2px;
            left: 2px;
        }
        .hannah-eye.left { left: 3px; }
        .hannah-eye.right { left: 19px; }
        /* Eyelashes */
        .hannah-eye::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 1px;
            width: 6px;
            height: 3px;
            border-top: 2px solid #333;
            border-radius: 50% 50% 0 0;
        }
        .hannah-smile {
            position: absolute;
            top: 22px;
            left: 8px;
            width: 14px;
            height: 7px;
            border: 2px solid #d47a7a;
            border-top: none;
            border-radius: 0 0 14px 14px;
            background: #ffb6c1;
        }
        /* Rosy cheeks */
        .hannah-cheek {
            width: 8px;
            height: 5px;
            background: rgba(255, 150, 150, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 18px;
        }
        .hannah-cheek.left { left: 0; }
        .hannah-cheek.right { left: 22px; }
        /* Hannah's Arms */
        .hannah-arm {
            width: 12px;
            height: 35px;
            background: #ffdbac;
            border-radius: 6px;
            position: absolute;
            bottom: 30px;
        }
        .hannah-arm.left {
            left: 8px;
            transform: rotate(20deg);
        }
        .hannah-arm.right {
            left: 70px;
            transform: rotate(-30deg);
            transform-origin: top center;
        }
        /* Pink sleeve cuffs */
        .hannah-arm::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            width: 16px;
            height: 10px;
            background: #ff69b4;
            border-radius: 8px 8px 0 0;
        }
        /* James - Baby boy in blue blanket */
        .james-bundle {
            position: absolute;
            bottom: 25px;
            left: 65px;
            width: 45px;
            height: 40px;
            background: linear-gradient(135deg, #87CEEB 0%, #6495ED 100%);
            border-radius: 20px 20px 15px 15px;
            border: 2px solid #4169E1;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }
        /* Blanket fold detail */
        .james-bundle::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
        }
        /* James's Head */
        .james-head {
            width: 28px;
            height: 28px;
            background: #ffdbac;
            border-radius: 50%;
            position: absolute;
            top: -18px;
            left: 8px;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.1);
        }
        /* James's tiny hair tuft */
        .james-hair {
            position: absolute;
            top: -22px;
            left: 15px;
            width: 12px;
            height: 8px;
            background: #deb887;
            border-radius: 50% 50% 0 0;
        }
        /* James's Face */
        .james-face {
            position: absolute;
            top: -15px;
            left: 12px;
            width: 20px;
            height: 18px;
        }
        .james-eye {
            width: 5px;
            height: 6px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 5px;
        }
        .james-eye.left { left: 2px; }
        .james-eye.right { left: 13px; }
        /* Baby smile */
        .james-smile {
            position: absolute;
            top: 13px;
            left: 6px;
            width: 8px;
            height: 4px;
            border: 2px solid #d47a7a;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        /* Pacifier */
        .james-pacifier {
            position: absolute;
            top: 11px;
            left: 5px;
            width: 10px;
            height: 8px;
            background: #90EE90;
            border-radius: 50%;
            border: 2px solid #32CD32;
        }
        .james-pacifier::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 2px;
            width: 6px;
            height: 6px;
            background: #32CD32;
            border-radius: 50%;
        }
        .speech-bubble {
            position: absolute;
            bottom: 260px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 20px;
            padding: 20px 30px;
            max-width: 500px;
            font-size: 18px;
            color: #333;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0;
            animation: bubbleFadeIn 0.5s ease-out 1s forwards;
        }
        @keyframes bubbleFadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border: 15px solid transparent;
            border-top-color: white;
        }
        .speech-bubble .noah-name {
            color: #0066ff;
            font-weight: bold;
        }
        .speech-bubble .mommy-name {
            color: #ff69b4;
            font-weight: bold;
        }
        .cutscene-stars {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 100px;
            overflow: hidden;
        }
        .star {
            position: absolute;
            width: 3px; height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 1.5s ease-in-out infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .click-continue {
            position: absolute;
            bottom: 50px;
            color: #aaa;
            font-size: 16px;
            animation: blink 1s ease-in-out infinite;
            opacity: 0;
            animation: blink 1s ease-in-out infinite 2s;
        }
        @keyframes blink {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Victory Cutscene */
        #victory-cutscene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #0a0a2a 0%, #1a0a1a 50%, #2a1515 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        .victory-scene {
            width: 800px;
            height: 450px;
            background: linear-gradient(180deg, #1a0520 0%, #3a2030 50%, #5a3030 100%);
            border-radius: 20px;
            border: 4px solid #ffcc00;
            box-shadow: 0 0 50px rgba(255,200,0,0.4);
            position: relative;
            overflow: hidden;
        }
        .victory-stars {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 120px;
            overflow: hidden;
        }
        .victory-ground {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 120px;
            background: linear-gradient(180deg, #8B4513 0%, #A0522D 100%);
            border-top: 3px solid #CD853F;
        }

        /* Rocket taking off */
        .victory-rocket {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            animation: rocketLaunch 4s ease-in forwards;
        }
        @keyframes rocketLaunch {
            0% { bottom: 120px; }
            20% { bottom: 120px; }
            100% { bottom: 600px; }
        }
        .rocket-body {
            width: 60px;
            height: 120px;
            background: linear-gradient(90deg, #ddd 0%, #fff 50%, #ccc 100%);
            border-radius: 30px 30px 10px 10px;
            position: relative;
        }
        .rocket-nose {
            position: absolute;
            top: -40px;
            left: 5px;
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid #cc0000;
        }
        .rocket-nose::after {
            content: '';
            position: absolute;
            top: -15px;
            left: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 20px solid #666;
        }
        .rocket-window {
            position: absolute;
            top: 30px;
            left: 18px;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #87CEEB, #4169E1);
            border-radius: 50%;
            border: 3px solid #666;
        }
        .rocket-stripe {
            position: absolute;
            left: 0;
            width: 100%;
            height: 10px;
            background: #cc0000;
        }
        .rocket-stripe.top { top: 20px; }
        .rocket-stripe.bottom { top: 70px; }
        .rocket-fin {
            position: absolute;
            bottom: -5px;
            width: 0;
            height: 0;
            border-top: 40px solid transparent;
            border-bottom: 20px solid #cc0000;
        }
        .rocket-fin.left {
            left: -20px;
            border-right: 25px solid #cc0000;
        }
        .rocket-fin.right {
            right: -20px;
            border-left: 25px solid #cc0000;
        }

        /* Rocket flame */
        .rocket-flame {
            position: absolute;
            bottom: -60px;
            left: 10px;
            width: 40px;
            height: 60px;
            animation: flameFlicker 0.1s ease-in-out infinite;
        }
        @keyframes flameFlicker {
            0%, 100% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(1.1) scaleX(0.95); }
        }
        .flame-outer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 60px;
            background: linear-gradient(180deg, #ff6600 0%, #ff3300 50%, #ffcc00 100%);
            border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
            opacity: 0.9;
        }
        .flame-inner {
            position: absolute;
            bottom: 5px;
            left: 10px;
            width: 20px;
            height: 40px;
            background: linear-gradient(180deg, #ffff00 0%, #ffcc00 100%);
            border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
        }
        .flame-core {
            position: absolute;
            bottom: 10px;
            left: 15px;
            width: 10px;
            height: 25px;
            background: #fff;
            border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
        }

        /* Smoke clouds */
        .smoke-cloud {
            position: absolute;
            bottom: 120px;
            border-radius: 50%;
            background: rgba(200, 200, 200, 0.8);
            animation: smokeRise 3s ease-out forwards;
        }
        @keyframes smokeRise {
            0% { opacity: 0.8; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(3) translateY(-100px); }
        }

        /* Family on ground watching */
        .victory-family {
            position: absolute;
            bottom: 120px;
            left: 150px;
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }

        /* Noah character (hero) */
        .victory-noah {
            position: relative;
            animation: noahCelebrate 0.5s ease-in-out infinite;
        }
        @keyframes noahCelebrate {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .noah-body {
            width: 40px;
            height: 50px;
            background: linear-gradient(180deg, #0066ff 0%, #0044cc 100%);
            border-radius: 20px 20px 10px 10px;
            position: relative;
        }
        .noah-head {
            width: 35px;
            height: 35px;
            background: #ffdbac;
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 2px;
        }
        .noah-hair {
            position: absolute;
            top: -35px;
            left: 0;
            width: 40px;
            height: 20px;
            background: #ffdd00;
            border-radius: 20px 20px 0 0;
        }
        .noah-face {
            position: absolute;
            top: -25px;
            left: 8px;
            width: 25px;
            height: 20px;
        }
        .noah-eye {
            width: 6px;
            height: 6px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 5px;
        }
        .noah-eye.left { left: 3px; }
        .noah-eye.right { left: 16px; }
        .noah-smile {
            position: absolute;
            top: 14px;
            left: 5px;
            width: 15px;
            height: 8px;
            border: 2px solid #d47a7a;
            border-top: none;
            border-radius: 0 0 15px 15px;
            background: #ffb6c1;
        }
        /* Noah's raised arms */
        .noah-arm-raised {
            position: absolute;
            width: 10px;
            height: 30px;
            background: #0066ff;
            border-radius: 5px;
            top: -15px;
        }
        .noah-arm-raised.left {
            left: -8px;
            transform: rotate(-45deg);
        }
        .noah-arm-raised.right {
            right: -8px;
            transform: rotate(45deg);
        }
        .noah-hand {
            position: absolute;
            bottom: -8px;
            width: 12px;
            height: 12px;
            background: #ffdbac;
            border-radius: 50%;
        }
        .noah-label {
            background: linear-gradient(135deg, #0066ff, #0044cc);
        }

        /* Dad character */
        .victory-dad {
            position: relative;
        }
        .dad-body {
            width: 45px;
            height: 70px;
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border-radius: 22px 22px 12px 12px;
            position: relative;
        }
        .dad-head {
            width: 40px;
            height: 40px;
            background: #ffcba4;
            border-radius: 50%;
            position: absolute;
            top: -35px;
            left: 2px;
        }
        .dad-hair {
            position: absolute;
            top: -40px;
            left: 0;
            width: 45px;
            height: 20px;
            background: #4a3728;
            border-radius: 20px 20px 0 0;
        }
        .dad-face {
            position: absolute;
            top: -28px;
            left: 10px;
        }
        .dad-eye {
            width: 5px;
            height: 5px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 5px;
        }
        .dad-eye.left { left: 3px; }
        .dad-eye.right { left: 18px; }
        .dad-smile {
            position: absolute;
            top: 15px;
            left: 5px;
            width: 16px;
            height: 8px;
            border: 2px solid #d47a7a;
            border-top: none;
            border-radius: 0 0 16px 16px;
        }
        .dad-label {
            background: linear-gradient(135deg, #333, #222);
        }

        /* Victory Hannah (smaller) */
        .victory-hannah-small {
            position: relative;
            transform: scale(0.7);
            transform-origin: bottom center;
        }

        /* Speech bubbles in victory */
        .victory-bubble {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 12px 18px;
            font-size: 16px;
            color: #333;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
            opacity: 0;
            max-width: 200px;
            text-align: center;
        }
        .victory-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border: 12px solid transparent;
            border-top-color: white;
        }
        .bubble-dad {
            bottom: 220px;
            left: 100px;
            animation: bubbleAppear 0.5s ease-out 1s forwards;
        }
        .bubble-hannah {
            bottom: 180px;
            left: 220px;
            animation: bubbleAppear 0.5s ease-out 2s forwards;
        }
        .bubble-noah {
            bottom: 200px;
            left: 50px;
            animation: bubbleAppear 0.5s ease-out 3s forwards;
        }
        @keyframes bubbleAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Victory title */
        .victory-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: 900;
            color: #ffcc00;
            text-shadow: 0 0 20px #ffcc00, 0 0 40px #ff6600, 3px 3px 0 #cc6600;
            animation: victoryPulse 1s ease-in-out infinite;
            letter-spacing: 5px;
        }
        @keyframes victoryPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        .victory-subtitle {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #87CEEB;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            opacity: 0;
            animation: subtitleAppear 1s ease-out 4s forwards;
        }
        @keyframes subtitleAppear {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Play Again button in victory */
        .victory-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            font-size: 22px;
            background: linear-gradient(135deg, #00cc66 0%, #009944 100%);
            border: none;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 200, 100, 0.4);
            opacity: 0;
            animation: btnAppear 0.5s ease-out 5s forwards;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .victory-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 200, 100, 0.6);
        }
        @keyframes btnAppear {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Hero label for Noah */
        .hero-badge {
            position: absolute;
            top: -55px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            color: #333;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 10px;
            white-space: nowrap;
            animation: badgeGlow 1s ease-in-out infinite;
        }
        @keyframes badgeGlow {
            0%, 100% { box-shadow: 0 0 10px #ffcc00; }
            50% { box-shadow: 0 0 20px #ffcc00, 0 0 30px #ff9900; }
        }

        /* ========== MAIN MENU ========== */
        #main-menu {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a2a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .menu-stars {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .menu-star {
            position: absolute;
            width: 3px; height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }
        .game-title {
            font-size: 72px;
            font-weight: 900;
            color: #ffcc00;
            text-shadow: 0 0 20px #ffcc00, 0 0 40px #ff9900, 4px 4px 0 #cc6600;
            margin-bottom: 10px;
            text-align: center;
            animation: titleFloat 3s ease-in-out infinite;
        }
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .game-subtitle {
            font-size: 24px;
            color: #87CEEB;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .missions-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 900px;
            padding: 20px;
        }
        .mission-card {
            width: 150px;
            height: 200px;
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a3a 100%);
            border-radius: 15px;
            border: 3px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .mission-card:hover:not(.locked) {
            transform: translateY(-10px);
            border-color: #ffcc00;
            box-shadow: 0 10px 30px rgba(255, 200, 0, 0.3);
        }
        .mission-card.locked {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .mission-card.locked::after {
            content: 'ðŸ”’';
            position: absolute;
            font-size: 40px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .mission-card.completed {
            border-color: #00cc66;
        }
        .mission-card.completed::before {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #00cc66;
            font-weight: bold;
        }
        .mission-card-number {
            font-size: 48px;
            font-weight: 900;
            color: #666;
            margin-bottom: 5px;
        }
        .mission-card:not(.locked) .mission-card-number {
            color: #ffcc00;
            text-shadow: 0 0 10px #ffcc00;
        }
        .mission-card.completed .mission-card-number {
            color: #00cc66;
            text-shadow: 0 0 10px #00cc66;
        }
        .mission-card-planet {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .mission-card.locked .mission-card-planet {
            filter: grayscale(1);
            opacity: 0.5;
        }
        .mission-card-name {
            font-size: 14px;
            color: #aaa;
            text-align: center;
            padding: 0 10px;
        }
        .mission-card:not(.locked) .mission-card-name {
            color: #fff;
        }
        .mission-card-status {
            position: absolute;
            bottom: 10px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mission-card.completed .mission-card-status {
            color: #00cc66;
        }
        .mission-card.locked .mission-card-status {
            color: #666;
        }
        .menu-footer {
            position: absolute;
            bottom: 30px;
            color: #555;
            font-size: 14px;
        }
        .menu-rocket {
            position: absolute;
            bottom: 100px;
            right: 50px;
            font-size: 60px;
            animation: rocketBob 2s ease-in-out infinite;
        }
        @keyframes rocketBob {
            0%, 100% { transform: translateY(0) rotate(-45deg); }
            50% { transform: translateY(-20px) rotate(-45deg); }
        }

        /* ========== MISSION 1 HUD ========== */
        #mission1-hud {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        .m1-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .m1-money-box {
            background: rgba(0, 80, 0, 0.85);
            border: 3px solid #00ff00;
            border-radius: 15px;
            padding: 15px 25px;
            color: #00ff00;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff00;
        }
        .m1-money-box span {
            color: #ffff00;
        }
        .m1-rocket-progress {
            background: rgba(0, 0, 80, 0.85);
            border: 3px solid #00ccff;
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            text-align: center;
        }
        .m1-rocket-title {
            font-size: 18px;
            color: #00ccff;
            margin-bottom: 10px;
        }
        .m1-parts-grid {
            display: flex;
            gap: 10px;
        }
        .m1-part {
            width: 50px;
            height: 50px;
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            opacity: 0.4;
        }
        .m1-part.owned {
            opacity: 1;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .m1-lemonade-stats {
            background: rgba(255, 200, 0, 0.9);
            border: 3px solid #ff9900;
            border-radius: 15px;
            padding: 12px 20px;
            color: #333;
            font-weight: bold;
        }
        .m1-bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .m1-controls {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 10px 15px;
            color: #aaa;
            font-size: 14px;
        }
        .m1-controls .key {
            background: #444;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #888;
        }
        .m1-tooltip {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #ffcc00;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            font-size: 18px;
            text-align: center;
            display: none;
            pointer-events: none;
            animation: tooltipPulse 1.5s ease-in-out infinite;
        }
        .m1-tooltip.show {
            display: block;
        }
        .m1-tooltip .key {
            background: #ffcc00;
            color: #000;
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin: 0 3px;
        }
        @keyframes tooltipPulse {
            0%, 100% { border-color: #ffcc00; box-shadow: 0 0 10px rgba(255, 204, 0, 0.3); }
            50% { border-color: #ffaa00; box-shadow: 0 0 20px rgba(255, 204, 0, 0.6); }
        }

        /* Conversation mode dialog */
        .m1-conversation-dialog {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #fff;
            border-radius: 20px;
            padding: 20px 30px;
            color: white;
            min-width: 400px;
            max-width: 600px;
            display: none;
            pointer-events: auto;
        }
        .m1-conversation-dialog.show {
            display: block;
        }
        .m1-conv-name {
            font-size: 22px;
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 10px;
        }
        .m1-conv-text {
            font-size: 18px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .m1-conv-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .m1-conv-option {
            padding: 12px 20px;
            background: linear-gradient(135deg, #333 0%, #222 100%);
            border: 2px solid #555;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .m1-conv-option:hover {
            background: linear-gradient(135deg, #444 0%, #333 100%);
            border-color: #ffcc00;
            transform: translateX(5px);
        }
        .m1-conv-option.mow {
            border-color: #00cc00;
        }
        .m1-conv-option.mow:hover {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .m1-conv-option.lemonade {
            border-color: #ffaa00;
        }
        .m1-conv-option.lemonade:hover {
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 200, 0, 0.3);
        }
        .m1-conv-option .price {
            float: right;
            color: #00ff00;
            font-weight: bold;
        }
        .m1-interaction-prompt {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffcc00;
            border-radius: 15px;
            padding: 15px 30px;
            color: white;
            font-size: 18px;
            text-align: center;
            display: none;
            pointer-events: auto;
        }
        .m1-interaction-prompt.show {
            display: block;
        }
        .m1-prompt-title {
            color: #ffcc00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .m1-prompt-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .m1-prompt-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .m1-prompt-btn:hover {
            transform: scale(1.05);
        }
        .m1-prompt-btn.mow {
            background: linear-gradient(135deg, #00cc00, #009900);
            color: white;
        }
        .m1-prompt-btn.lemonade {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            color: #333;
        }
        .m1-prompt-btn.shop {
            background: linear-gradient(135deg, #00ccff, #0099cc);
            color: white;
        }
        .m1-prompt-btn.cancel {
            background: #666;
            color: white;
        }
        .m1-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            border-radius: 20px;
            padding: 20px 40px;
            color: white;
            font-size: 24px;
            text-align: center;
            display: none;
            animation: notifyPop 0.3s ease-out;
        }
        @keyframes notifyPop {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .m1-shop-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #1a1a3a 0%, #2a2a5a 100%);
            border: 4px solid #00ccff;
            border-radius: 20px;
            padding: 30px;
            color: white;
            display: none;
            pointer-events: auto;
            min-width: 500px;
        }
        .m1-shop-title {
            font-size: 32px;
            color: #00ccff;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ccff;
        }
        .m1-shop-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .m1-shop-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
        }
        .m1-shop-item.owned {
            border-color: #00ff00;
            background: rgba(0, 100, 0, 0.3);
        }
        .m1-shop-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .m1-shop-item-icon {
            font-size: 40px;
        }
        .m1-shop-item-name {
            font-size: 20px;
            font-weight: bold;
        }
        .m1-shop-item-desc {
            font-size: 12px;
            color: #aaa;
        }
        .m1-shop-item-price {
            font-size: 24px;
            color: #00ff00;
            font-weight: bold;
        }
        .m1-shop-item-btn {
            padding: 10px 25px;
            background: linear-gradient(135deg, #00cc00, #009900);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .m1-shop-item-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .m1-shop-item-btn.purchased {
            background: #333;
        }
        .m1-shop-close {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: #cc0000;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Mission 1 Intro */
        #mission1-intro {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a2a1a 0%, #2a3a2a 50%, #1a3a2a 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #mission1-cutscene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .m1-cutscene-scene {
            width: 700px;
            height: 350px;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 50%, #228B22 100%);
            border-radius: 20px;
            border: 4px solid #228B22;
            box-shadow: 0 0 30px rgba(0,100,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .m1-grass {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 100px;
            background: linear-gradient(180deg, #32CD32 0%, #228B22 100%);
        }
        .m1-house {
            position: absolute;
            bottom: 100px;
            width: 120px;
            height: 100px;
            background: linear-gradient(180deg, #DEB887 0%, #D2B48C 100%);
            border: 3px solid #8B4513;
        }
        .m1-house::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -10px;
            width: 0;
            height: 0;
            border-left: 70px solid transparent;
            border-right: 70px solid transparent;
            border-bottom: 60px solid #8B0000;
        }
        .m1-house-door {
            position: absolute;
            bottom: 0;
            left: 45px;
            width: 30px;
            height: 50px;
            background: #8B4513;
            border: 2px solid #654321;
        }
        .m1-house-window {
            position: absolute;
            top: 20px;
            width: 25px;
            height: 25px;
            background: #87CEEB;
            border: 3px solid #fff;
        }
        .m1-sun {
            position: absolute;
            top: 30px;
            right: 50px;
            width: 60px;
            height: 60px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 30px #FFD700, 0 0 60px #FFA500;
        }
        .m1-cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
        }
    </style>
</head>
<body>

    <!-- Main Menu -->
    <div id="main-menu">
        <div class="menu-stars">
            <div class="menu-star" style="top: 10%; left: 5%; animation-delay: 0s;"></div>
            <div class="menu-star" style="top: 20%; left: 15%; animation-delay: 0.3s;"></div>
            <div class="menu-star" style="top: 5%; left: 30%; animation-delay: 0.7s;"></div>
            <div class="menu-star" style="top: 15%; left: 50%; animation-delay: 0.2s;"></div>
            <div class="menu-star" style="top: 8%; left: 70%; animation-delay: 0.5s;"></div>
            <div class="menu-star" style="top: 25%; left: 85%; animation-delay: 0.1s;"></div>
            <div class="menu-star" style="top: 30%; left: 95%; animation-delay: 0.8s;"></div>
            <div class="menu-star" style="top: 60%; left: 8%; animation-delay: 0.4s;"></div>
            <div class="menu-star" style="top: 75%; left: 20%; animation-delay: 0.6s;"></div>
            <div class="menu-star" style="top: 85%; left: 40%; animation-delay: 0.9s;"></div>
            <div class="menu-star" style="top: 70%; left: 60%; animation-delay: 0.15s;"></div>
            <div class="menu-star" style="top: 90%; left: 75%; animation-delay: 0.45s;"></div>
            <div class="menu-star" style="top: 80%; left: 90%; animation-delay: 0.75s;"></div>
        </div>

        <div class="game-title">Noah's Space Adventure</div>
        <div class="game-subtitle">Save the Family Across the Galaxy!</div>

        <div class="missions-container">
            <!-- Mission 1 - Build the Rocket -->
            <div class="mission-card" data-mission="1" onclick="startMission(1)">
                <div class="mission-card-number">1</div>
                <div class="mission-card-planet">ðŸš€</div>
                <div class="mission-card-name">Build the Rocket</div>
                <div class="mission-card-status">Play Now!</div>
            </div>

            <!-- Mission 2 - Asteroid Belt -->
            <div class="mission-card locked" data-mission="2">
                <div class="mission-card-number">2</div>
                <div class="mission-card-planet">â˜„ï¸</div>
                <div class="mission-card-name">Asteroid Belt</div>
                <div class="mission-card-status">Coming Soon</div>
            </div>

            <!-- Mission 3 - Mars (PLAYABLE) -->
            <div class="mission-card" data-mission="3" onclick="startMission(3)">
                <div class="mission-card-number">3</div>
                <div class="mission-card-planet">ðŸ”´</div>
                <div class="mission-card-name">Mars Defense</div>
                <div class="mission-card-status">Play Now!</div>
            </div>

            <!-- Mission 4 - Jupiter -->
            <div class="mission-card locked" data-mission="4">
                <div class="mission-card-number">4</div>
                <div class="mission-card-planet">ðŸŸ </div>
                <div class="mission-card-name">Jupiter's Storm</div>
                <div class="mission-card-status">Coming Soon</div>
            </div>

            <!-- Mission 5 - Home -->
            <div class="mission-card locked" data-mission="5">
                <div class="mission-card-number">5</div>
                <div class="mission-card-planet">ðŸŒ</div>
                <div class="mission-card-name">Return to Earth</div>
                <div class="mission-card-status">Coming Soon</div>
            </div>
        </div>

        <div class="menu-rocket">ðŸš€</div>
        <div class="menu-footer">Progress is saved automatically</div>
    </div>

    <!-- Mission Intro Screen -->
    <div id="mission-intro">
        <div class="scan-line"></div>
        <div class="corner-decor tl"></div>
        <div class="corner-decor tr"></div>
        <div class="corner-decor bl"></div>
        <div class="corner-decor br"></div>
        <div class="mission-container">
            <div class="mission-label">INCOMING TRANSMISSION</div>
            <div class="mission-number">MISSION 3</div>
            <div class="mission-title">
                Protect <span class="highlight">Hannah</span> and <span class="highlight">James</span><br>
                while Dad fixes the ship
            </div>
        </div>
    </div>

    <!-- Cutscene Screen -->
    <div id="cutscene">
        <div class="cutscene-scene">
            <div class="cutscene-stars">
                <div class="star" style="top: 20px; left: 50px; animation-delay: 0s;"></div>
                <div class="star" style="top: 60px; left: 150px; animation-delay: 0.3s;"></div>
                <div class="star" style="top: 30px; left: 300px; animation-delay: 0.6s;"></div>
                <div class="star" style="top: 80px; left: 400px; animation-delay: 0.2s;"></div>
                <div class="star" style="top: 40px; left: 550px; animation-delay: 0.8s;"></div>
                <div class="star" style="top: 100px; left: 620px; animation-delay: 0.4s;"></div>
                <div class="star" style="top: 15px; left: 680px; animation-delay: 0.1s;"></div>
                <div class="star" style="top: 90px; left: 100px; animation-delay: 0.5s;"></div>
                <div class="star" style="top: 50px; left: 480px; animation-delay: 0.7s;"></div>
            </div>
            <div class="mars-ground"></div>
            <div class="cutscene-hannah">
                <div class="hannah-container">
                    <!-- Hannah's name label -->
                    <div class="character-label hannah-label">Hannah</div>

                    <!-- Hannah's Hair -->
                    <div class="hannah-hair"></div>
                    <div class="hannah-hair-left"></div>
                    <div class="hannah-hair-right"></div>

                    <!-- Hannah's Head -->
                    <div class="hannah-head"></div>

                    <!-- Hannah's Face -->
                    <div class="hannah-face">
                        <div class="hannah-eye left"></div>
                        <div class="hannah-eye right"></div>
                        <div class="hannah-cheek left"></div>
                        <div class="hannah-cheek right"></div>
                        <div class="hannah-smile"></div>
                    </div>

                    <!-- Hannah's Body (Pink Dress) -->
                    <div class="hannah-body"></div>

                    <!-- Hannah's Arms -->
                    <div class="hannah-arm left"></div>
                    <div class="hannah-arm right"></div>

                    <!-- Baby James in blue blanket -->
                    <div class="james-bundle">
                        <div class="character-label james-label">Baby James</div>
                        <div class="james-hair"></div>
                        <div class="james-head"></div>
                        <div class="james-face">
                            <div class="james-eye left"></div>
                            <div class="james-eye right"></div>
                            <div class="james-smile"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="speech-bubble">
                "You can do it <span class="noah-name">Noah</span>! Protect us so Daddy can fix the ship and we can get back to <span class="mommy-name">Mommy</span>!"
            </div>
        </div>
        <div class="click-continue">Click anywhere to start...</div>
    </div>

    <div id="ui-layer">
        <div class="top-hud">
            <div class="repair-label">ROCKET REPAIR STATUS (Dad is working...)</div>
            <div class="progress-container"><div id="repair-bar"></div></div>
        </div>

        <div class="status-box">
            <div class="hannah-hp">Hannah & James Health: <span id="hp-val">100</span>%</div>
        </div>

        <div class="controls">
            <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> Move &nbsp;|&nbsp;
            <span class="key">MOUSE</span> Aim &nbsp;|&nbsp;
            <span class="key">L-CLICK</span> Blaster &nbsp;|&nbsp;
            <span class="key">SPACE</span> Sword
        </div>
    </div>

    <div id="overlay">
        <h1 id="ov-title">GAME OVER</h1>
        <h2 id="ov-desc">Aliens got too close!</h2>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button id="restart-btn" onclick="resetGame()">Try Again</button>
            <button id="restart-btn" onclick="returnToMenu()" style="background: #6666ff;">Main Menu</button>
        </div>
    </div>

    <!-- Victory Cutscene -->
    <div id="victory-cutscene">
        <div class="victory-scene">
            <!-- Stars background -->
            <div class="victory-stars">
                <div class="star" style="top: 30px; left: 80px; animation-delay: 0s;"></div>
                <div class="star" style="top: 70px; left: 200px; animation-delay: 0.3s;"></div>
                <div class="star" style="top: 20px; left: 350px; animation-delay: 0.6s;"></div>
                <div class="star" style="top: 90px; left: 500px; animation-delay: 0.2s;"></div>
                <div class="star" style="top: 50px; left: 650px; animation-delay: 0.8s;"></div>
                <div class="star" style="top: 110px; left: 720px; animation-delay: 0.4s;"></div>
                <div class="star" style="top: 25px; left: 780px; animation-delay: 0.1s;"></div>
                <div class="star" style="top: 100px; left: 150px; animation-delay: 0.5s;"></div>
                <div class="star" style="top: 60px; left: 580px; animation-delay: 0.7s;"></div>
                <div class="star" style="top: 40px; left: 450px; animation-delay: 0.9s;"></div>
            </div>

            <!-- Mars ground -->
            <div class="victory-ground"></div>

            <!-- Victory Title -->
            <div class="victory-title">BLAST OFF!</div>
            <div class="victory-subtitle">Next Stop: Knoxville, TN to see Mommy!</div>

            <!-- Rocket launching -->
            <div class="victory-rocket">
                <div class="rocket-body">
                    <div class="rocket-nose"></div>
                    <div class="rocket-window"></div>
                    <div class="rocket-stripe top"></div>
                    <div class="rocket-stripe bottom"></div>
                    <div class="rocket-fin left"></div>
                    <div class="rocket-fin right"></div>
                    <div class="rocket-flame">
                        <div class="flame-outer"></div>
                        <div class="flame-inner"></div>
                        <div class="flame-core"></div>
                    </div>
                </div>
            </div>

            <!-- Smoke clouds -->
            <div class="smoke-cloud" style="left: 380px; width: 40px; height: 40px; animation-delay: 0.8s;"></div>
            <div class="smoke-cloud" style="left: 420px; width: 50px; height: 50px; animation-delay: 1s;"></div>
            <div class="smoke-cloud" style="left: 360px; width: 35px; height: 35px; animation-delay: 1.2s;"></div>
            <div class="smoke-cloud" style="left: 400px; width: 45px; height: 45px; animation-delay: 1.4s;"></div>

            <!-- Family watching -->
            <div class="victory-family">
                <!-- Noah (the hero!) -->
                <div class="victory-noah">
                    <div class="hero-badge">HERO!</div>
                    <div class="noah-body">
                        <div class="noah-hair"></div>
                        <div class="noah-head"></div>
                        <div class="noah-face">
                            <div class="noah-eye left"></div>
                            <div class="noah-eye right"></div>
                            <div class="noah-smile"></div>
                        </div>
                        <div class="noah-arm-raised left">
                            <div class="noah-hand"></div>
                        </div>
                        <div class="noah-arm-raised right">
                            <div class="noah-hand"></div>
                        </div>
                    </div>
                </div>

                <!-- Dad -->
                <div class="victory-dad">
                    <div class="dad-body">
                        <div class="dad-hair"></div>
                        <div class="dad-head"></div>
                        <div class="dad-face">
                            <div class="dad-eye left"></div>
                            <div class="dad-eye right"></div>
                            <div class="dad-smile"></div>
                        </div>
                    </div>
                </div>

                <!-- Hannah holding James (smaller version) -->
                <div class="victory-hannah-small">
                    <div class="hannah-container">
                        <div class="hannah-hair"></div>
                        <div class="hannah-hair-left"></div>
                        <div class="hannah-hair-right"></div>
                        <div class="hannah-head"></div>
                        <div class="hannah-face">
                            <div class="hannah-eye left"></div>
                            <div class="hannah-eye right"></div>
                            <div class="hannah-cheek left"></div>
                            <div class="hannah-cheek right"></div>
                            <div class="hannah-smile"></div>
                        </div>
                        <div class="hannah-body"></div>
                        <div class="hannah-arm left"></div>
                        <div class="hannah-arm right"></div>
                        <div class="james-bundle">
                            <div class="james-hair"></div>
                            <div class="james-head"></div>
                            <div class="james-face">
                                <div class="james-eye left"></div>
                                <div class="james-eye right"></div>
                                <div class="james-smile"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Speech bubbles praising Noah -->
            <div class="victory-bubble bubble-dad">
                "Great job <span style="color: #0066ff; font-weight: bold;">Noah</span>! You saved us all!"
            </div>
            <div class="victory-bubble bubble-hannah">
                "You're the best big brother ever!"
            </div>
            <div class="victory-bubble bubble-noah">
                "Let's go see <span style="color: #ff69b4; font-weight: bold;">Mommy</span>!"
            </div>
        </div>

        <div style="display: flex; gap: 20px; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); opacity: 0; animation: btnAppear 0.5s ease-out 5s forwards;">
            <button class="victory-btn" style="position: static; transform: none; animation: none; opacity: 1;" onclick="resetGame()">Play Again</button>
            <button class="victory-btn" style="position: static; transform: none; animation: none; opacity: 1; background: linear-gradient(135deg, #6666ff 0%, #4444cc 100%);" onclick="returnToMenu()">Main Menu</button>
        </div>
    </div>

    <!-- Mission 1 Intro Screen -->
    <div id="mission1-intro">
        <div class="scan-line"></div>
        <div class="corner-decor tl"></div>
        <div class="corner-decor tr"></div>
        <div class="corner-decor bl"></div>
        <div class="corner-decor br"></div>
        <div class="mission-container">
            <div class="mission-label">NEW ADVENTURE</div>
            <div class="mission-number">MISSION 1</div>
            <div class="mission-title">
                Build a <span class="highlight">Rocket</span> to go to<br>
                <span class="highlight">SPACE!</span>
            </div>
        </div>
    </div>

    <!-- Mission 1 Cutscene -->
    <div id="mission1-cutscene">
        <div class="m1-cutscene-scene">
            <div class="m1-sun"></div>
            <div class="m1-cloud" style="top: 40px; left: 100px; width: 80px; height: 30px;"></div>
            <div class="m1-cloud" style="top: 60px; left: 300px; width: 100px; height: 35px;"></div>
            <div class="m1-grass"></div>
            <div class="m1-house" style="left: 50px;">
                <div class="m1-house-door"></div>
                <div class="m1-house-window" style="left: 15px;"></div>
                <div class="m1-house-window" style="left: 80px;"></div>
            </div>
        </div>
        <div class="speech-bubble" style="bottom: 280px;">
            "I want to go to <span class="noah-name">SPACE</span>! I need to earn money to buy rocket parts. I can mow lawns, and <span class="mommy-name">Hannah</span> can help at the lemonade stand!"
        </div>
        <div class="click-continue">Click anywhere to start...</div>
    </div>

    <!-- Mission 1 HUD -->
    <div id="mission1-hud">
        <div class="m1-top-bar">
            <div class="m1-money-box">
                $ <span id="m1-money">0</span>
            </div>
            <div class="m1-rocket-progress">
                <div class="m1-rocket-title">ROCKET PARTS</div>
                <div class="m1-parts-grid">
                    <div class="m1-part" id="part-engine" title="Engine">ðŸ”¥</div>
                    <div class="m1-part" id="part-body" title="Body">ðŸ›¢ï¸</div>
                    <div class="m1-part" id="part-nose" title="Nose Cone">ðŸ”º</div>
                    <div class="m1-part" id="part-fins" title="Fins">ðŸ”§</div>
                    <div class="m1-part" id="part-seat" title="Seat">ðŸ’º</div>
                </div>
            </div>
            <div class="m1-lemonade-stats">
                ðŸ‹ Lemonade Stand: $<span id="m1-lemonade-earnings">0</span>
                <br><small>Customers waiting: <span id="m1-customers">0</span></small>
            </div>
        </div>
        <div class="m1-bottom-bar">
            <div class="m1-controls">
                <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> Move &nbsp;|&nbsp;
                <span class="key">E</span> Interact &nbsp;|&nbsp;
                <span class="key">SPACE</span> Action
            </div>
        </div>

        <!-- Interaction Prompt -->
        <div class="m1-interaction-prompt" id="m1-prompt">
            <div class="m1-prompt-title" id="m1-prompt-title">Neighbor</div>
            <div id="m1-prompt-text">What would you like to do?</div>
            <div id="m1-prompt-mood"></div>
            <div class="m1-prompt-buttons" id="m1-prompt-buttons">
                <!-- Buttons added dynamically -->
            </div>
        </div>

        <!-- Tooltip for interactions -->
        <div class="m1-tooltip" id="m1-tooltip">
            Press <span class="key">E</span> to interact
        </div>

        <!-- Conversation dialog -->
        <div class="m1-conversation-dialog" id="m1-conversation">
            <div class="m1-conv-name" id="m1-conv-name">Neighbor Name</div>
            <div class="m1-conv-text" id="m1-conv-text">"Hello there, Noah!"</div>
            <div class="m1-conv-options" id="m1-conv-options">
                <!-- Options populated dynamically -->
            </div>
        </div>

        <!-- Notification popup -->
        <div class="m1-notification" id="m1-notification"></div>

        <!-- Shop Panel -->
        <div class="m1-shop-panel" id="m1-shop">
            <div class="m1-shop-title">ðŸš€ ROCKET SHOP ðŸš€</div>
            <div class="m1-shop-items" id="m1-shop-items">
                <!-- Items added dynamically -->
            </div>
            <button class="m1-shop-close" onclick="closeShop()">Close Shop</button>
        </div>
    </div>

    <!-- Mission 1 Victory -->
    <div id="mission1-victory" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #0a0a2a 0%, #1a1a4a 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1001;">
        <div style="text-align: center;">
            <div style="font-size: 72px; margin-bottom: 20px;">ðŸš€</div>
            <h1 style="font-size: 48px; color: #ffcc00; text-shadow: 0 0 20px #ffcc00; margin: 0;">ROCKET COMPLETE!</h1>
            <p style="font-size: 24px; color: #87CEEB; margin-top: 20px;">Noah built his rocket and is ready for space!</p>
            <p style="font-size: 18px; color: #aaa; margin-top: 10px;">Great job earning money and buying all the parts!</p>
            <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
                <button class="victory-btn" style="position: static; transform: none; opacity: 1;" onclick="returnToMenu()">Continue Adventure</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        let gameState = "menu"; // menu, intro, cutscene, playing, won, lost, m1_intro, m1_cutscene, m1_playing
        let currentMission = 0;
        let repairProgress = 0; // 0 to 100
        let hannahHealth = 100;
        let introTimeout = null;

        // ============ MISSION 1 VARIABLES ============
        let m1Money = 0;
        let m1LemonadeEarnings = 0;
        let m1CustomersWaiting = 0;
        let m1IsShopOpen = false;
        let m1IsMowing = false;
        let m1MowingProgress = 0;
        let m1CurrentMowingNeighbor = null;

        // Mowing mini-game state
        let m1MowingMiniGame = false;
        let m1MowingLawn = {
            grassTiles: [],
            mowerX: 0,
            mowerZ: 0,
            mowerAngle: 0,
            totalTiles: 0,
            cutTiles: 0,
            lawnWidth: 10,
            lawnHeight: 8,
            tileSize: 20,
            originalNoahPos: { x: 0, z: 0 },
            houseX: 0,
            houseZ: 0
        };
        let m1InteractingNeighbor = null;
        let m1ShowingPrompt = false;

        // Conversation cutscene mode
        let m1InConversation = false;
        let m1ConversationNeighbor = null;
        let m1ConversationPhase = 0; // 0=door opening, 1=talking, 2=ending
        let m1ConversationTimer = 0;
        let m1CameraTarget = { x: 0, y: 0, z: 0 };
        let m1CameraPos = { x: 0, y: 0, z: 0 };

        // Neighbor walking animation
        let m1WalkingNeighbors = []; // Neighbors currently walking to lemonade stand

        // Lemonade drinking animation
        let m1DrinkingNeighbors = []; // Neighbors currently drinking at stand

        // Rocket parts: engine, body, nose, fins, seat
        let m1RocketParts = {
            engine: { owned: false, price: 50, name: "Engine", icon: "ðŸ”¥", desc: "Powers the rocket!" },
            body: { owned: false, price: 40, name: "Body", icon: "ðŸ›¢ï¸", desc: "Main rocket structure" },
            nose: { owned: false, price: 30, name: "Nose Cone", icon: "ðŸ”º", desc: "Aerodynamic tip" },
            fins: { owned: false, price: 25, name: "Fins", icon: "ðŸ”§", desc: "Stabilize flight" },
            seat: { owned: false, price: 35, name: "Captain's Seat", icon: "ðŸ’º", desc: "A comfy seat for Noah" }
        };

        // Neighbors in the neighborhood
        let m1Neighbors = [];
        let m1Houses = [];
        let m1LemonadeStand = { x: -150, z: 120, customers: [] }; // Along the street
        let m1RocketShop = { x: 350, z: 100 }; // At the end of Belle Pond Ave
        let m1Trees = [];
        let m1Flowers = [];
        let m1Roads = [];
        let m1Lake = { x: 350, z: 250, width: 300, height: 150 }; // Lake at end of street

        // Niam - neighborhood friend who wants to play
        let m1Niam = {
            x: 0, z: 0,
            isApproaching: false,
            showingDialog: false,
            lastApproachTime: 0,
            approachCooldown: 1800 // 30 seconds at 60fps
        };

        // Initialize Mission 1 neighbors
        function initMission1() {
            m1Money = 0;
            m1LemonadeEarnings = 0;
            m1CustomersWaiting = 0;
            m1IsMowing = false;
            m1MowingMiniGame = false;
            m1MowingProgress = 0;
            m1IsShopOpen = false;
            m1ShowingPrompt = false;
            m1InteractingNeighbor = null;
            m1InConversation = false;
            m1ConversationNeighbor = null;
            m1ConversationPhase = 0;
            m1ConversationTimer = 0;
            m1WalkingNeighbors = [];
            m1DrinkingNeighbors = [];

            // Reset rocket parts
            for (let key in m1RocketParts) {
                m1RocketParts[key].owned = false;
            }

            // Reset Niam
            m1Niam.isApproaching = false;
            m1Niam.showingDialog = false;
            m1Niam.lastApproachTime = 0;
            m1Niam.x = -300;
            m1Niam.z = 50;

            // Create neighbors - Belle Pond Ave layout (one curved row of houses)
            // Houses face south toward the road, lake is at the end of the street
            m1Neighbors = [
                // House 1 - Start of Belle Pond Ave
                {
                    name: "Mrs. Smith",
                    homeX: -250, homeZ: 180,
                    x: -250, z: 130,
                    currentX: -250, currentZ: 130,
                    mood: 100,
                    askCount: 0,
                    isHome: true,
                    atLemonade: false,
                    isWalking: false,
                    isDrinking: false,
                    drinkTimer: 0,
                    doorOpen: false,
                    hairColor: [139, 69, 19],
                    shirtColor: [200, 100, 150],
                    pantsColor: [80, 80, 120],
                    mowPay: 12,
                    houseColor: [200, 200, 190],
                    roofColor: [80, 80, 85],
                    facingSouth: true
                },
                // House 2
                {
                    name: "Mr. Johnson",
                    homeX: -120, homeZ: 200,
                    x: -120, z: 150,
                    currentX: -120, currentZ: 150,
                    mood: 100,
                    askCount: 0,
                    isHome: true,
                    atLemonade: false,
                    isWalking: false,
                    isDrinking: false,
                    drinkTimer: 0,
                    doorOpen: false,
                    hairColor: [80, 80, 80],
                    shirtColor: [50, 100, 50],
                    pantsColor: [60, 60, 80],
                    mowPay: 15,
                    houseColor: [220, 200, 180],
                    roofColor: [80, 80, 90],
                    facingSouth: true
                },
                // House 3 - THE PINNED HOUSE (The Rudys - center of the street!)
                {
                    name: "The Rudys",
                    homeX: 10, homeZ: 210,
                    x: 10, z: 160,
                    currentX: 10, currentZ: 160,
                    mood: 100,
                    askCount: 0,
                    isHome: true,
                    atLemonade: false,
                    isWalking: false,
                    isDrinking: false,
                    drinkTimer: 0,
                    doorOpen: false,
                    hairColor: [139, 90, 43],
                    shirtColor: [65, 105, 225],
                    pantsColor: [50, 50, 70],
                    mowPay: 20,
                    houseColor: [210, 200, 185],
                    roofColor: [85, 85, 95],
                    facingSouth: true,
                    isPinned: true
                },
                // House 4
                {
                    name: "Grandma Rose",
                    homeX: 140, homeZ: 200,
                    x: 140, z: 150,
                    currentX: 140, currentZ: 150,
                    mood: 100,
                    askCount: 0,
                    isHome: true,
                    atLemonade: false,
                    isWalking: false,
                    isDrinking: false,
                    drinkTimer: 0,
                    doorOpen: false,
                    hairColor: [200, 200, 200],
                    shirtColor: [180, 100, 180],
                    pantsColor: [100, 80, 100],
                    mowPay: 22,
                    houseColor: [205, 195, 180],
                    roofColor: [90, 85, 80],
                    facingSouth: true
                },
                // House 5 - Near the lake end
                {
                    name: "Dr. Patel",
                    homeX: 260, homeZ: 180,
                    x: 260, z: 130,
                    currentX: 260, currentZ: 130,
                    mood: 100,
                    askCount: 0,
                    isHome: true,
                    atLemonade: false,
                    isWalking: false,
                    isDrinking: false,
                    drinkTimer: 0,
                    doorOpen: false,
                    hairColor: [30, 30, 30],
                    shirtColor: [255, 255, 255],
                    pantsColor: [40, 40, 50],
                    mowPay: 19,
                    houseColor: [215, 205, 190],
                    roofColor: [70, 70, 80],
                    facingSouth: true
                },
            ];

            // Create houses from neighbors (linked)
            m1Houses = m1Neighbors.map(n => ({
                x: n.homeX,
                z: n.homeZ,
                color: n.houseColor,
                roofColor: n.roofColor,
                owner: n,
                facingSouth: n.facingSouth || false,
                facingEast: n.facingEast || false,
                facingWest: n.facingWest || false,
                isPinned: n.isPinned || false
            }));

            // Create decorative trees - behind houses and around lake
            m1Trees = [];
            // Trees behind houses (north side of houses)
            for (let i = 0; i < 6; i++) {
                m1Trees.push({
                    x: -280 + i * 110,
                    z: 260 + random(-20, 20),
                    height: random(50, 80),
                    width: random(30, 45)
                });
            }
            // Trees around the lake
            for (let i = 0; i < 4; i++) {
                m1Trees.push({
                    x: 320 + random(-30, 50),
                    z: 280 + i * 40 + random(-10, 10),
                    height: random(45, 70),
                    width: random(25, 40)
                });
            }
            // Trees at street entrance
            m1Trees.push({ x: -380, z: 20, height: 60, width: 35 });
            m1Trees.push({ x: -380, z: 80, height: 65, width: 38 });
            // Trees on far side of road
            m1Trees.push({ x: -200, z: -20, height: 55, width: 32 });
            m1Trees.push({ x: 50, z: -30, height: 60, width: 36 });

            // Create flowers - in yards
            m1Flowers = [];
            for (let i = 0; i < 40; i++) {
                // Scatter in yard areas, avoid road
                let fx = random(-320, 320);
                let fz = random(-100, 350);
                // Skip if on road area
                if (Math.abs(fx) < 80 && fz < 200 && fz > -150) continue;
                m1Flowers.push({
                    x: fx,
                    z: fz,
                    color: random([[255, 100, 100], [255, 255, 100], [255, 150, 200], [150, 150, 255], [255, 200, 100]])
                });
            }

            // Reset Noah's position - at the entrance of the cul-de-sac
            noah.x = 0;
            noah.z = -80;

            updateM1HUD();
        }

        function updateM1HUD() {
            document.getElementById('m1-money').textContent = m1Money;
            document.getElementById('m1-lemonade-earnings').textContent = m1LemonadeEarnings;
            document.getElementById('m1-customers').textContent = m1CustomersWaiting;

            // Update rocket parts display
            for (let key in m1RocketParts) {
                const el = document.getElementById('part-' + key);
                if (el) {
                    if (m1RocketParts[key].owned) {
                        el.classList.add('owned');
                    } else {
                        el.classList.remove('owned');
                    }
                }
            }
        }

        function showM1Notification(text, duration = 2000) {
            const notif = document.getElementById('m1-notification');
            notif.textContent = text;
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, duration);
        }

        function getMoodEmoji(mood) {
            if (mood >= 80) return "ðŸ˜Š";
            if (mood >= 60) return "ðŸ˜";
            if (mood >= 40) return "ðŸ˜•";
            if (mood >= 20) return "ðŸ˜ ";
            return "ðŸ˜¡";
        }

        function getMoodColor(mood) {
            if (mood >= 80) return "#00ff00";
            if (mood >= 60) return "#88ff00";
            if (mood >= 40) return "#ffff00";
            if (mood >= 20) return "#ff8800";
            return "#ff0000";
        }

        function showNeighborPrompt(neighbor) {
            // Start the 3D conversation cutscene
            startConversation(neighbor);
        }

        function startConversation(neighbor) {
            m1InConversation = true;
            m1ConversationNeighbor = neighbor;
            m1ConversationPhase = 0;
            m1ConversationTimer = 0;
            neighbor.doorOpen = true;

            // Set camera target to the house door area
            m1CameraTarget.x = neighbor.homeX;
            m1CameraTarget.z = neighbor.homeZ + 80;

            // Show conversation dialog after door opens
            setTimeout(() => {
                if (m1InConversation) {
                    m1ConversationPhase = 1;
                    showConversationDialog(neighbor);
                }
            }, 600);
        }

        function showConversationDialog(neighbor) {
            const dialog = document.getElementById('m1-conversation');
            const nameEl = document.getElementById('m1-conv-name');
            const textEl = document.getElementById('m1-conv-text');
            const optionsEl = document.getElementById('m1-conv-options');

            nameEl.textContent = neighbor.name;
            nameEl.style.color = `rgb(${neighbor.shirtColor[0]}, ${neighbor.shirtColor[1]}, ${neighbor.shirtColor[2]})`;

            if (neighbor.mood <= 20) {
                textEl.textContent = `"Go away, Noah! You've been bothering me too much today!"`;
                optionsEl.innerHTML = `
                    <button class="m1-conv-option" onclick="endConversation()">
                        "Sorry, I'll come back later..."
                    </button>
                `;
            } else {
                let greeting = "";
                if (neighbor.mood >= 80) {
                    greeting = `"Well hello there, Noah! What can I do for you today?"`;
                } else if (neighbor.mood >= 50) {
                    greeting = `"Oh, hi Noah. What do you need?"`;
                } else {
                    greeting = `"Yes? What is it now?"`;
                }
                textEl.textContent = greeting;

                let optionsHTML = '';
                if (!m1IsMowing) {
                    optionsHTML += `
                        <button class="m1-conv-option mow" onclick="conversationMow()">
                            "Can I mow your lawn?" <span class="price">+$${neighbor.mowPay}</span>
                        </button>
                    `;
                }
                optionsHTML += `
                    <button class="m1-conv-option lemonade" onclick="conversationLemonade()">
                        "Would you like to buy some lemonade? My sister Hannah is selling it!"
                    </button>
                    <button class="m1-conv-option" onclick="endConversation()">
                        "Never mind, goodbye!"
                    </button>
                `;
                optionsEl.innerHTML = optionsHTML;
            }

            dialog.classList.add('show');
        }

        function conversationMow() {
            if (!m1ConversationNeighbor) return;
            const neighbor = m1ConversationNeighbor;
            neighbor.mood -= 10;
            neighbor.askCount++;
            if (neighbor.mood <= 0) neighbor.mood = 0;

            document.getElementById('m1-conversation').classList.remove('show');

            // Start mowing mini-game
            m1IsMowing = true;
            m1MowingMiniGame = true;
            m1MowingProgress = 0;
            m1CurrentMowingNeighbor = neighbor;

            // Find this neighbor's house position
            const house = m1Houses.find(h => h.owner === neighbor);

            // Initialize the lawn grid
            m1MowingLawn.originalNoahPos = { x: noah.x, z: noah.z };
            m1MowingLawn.houseX = house ? house.x : neighbor.homeX;
            m1MowingLawn.houseZ = house ? house.z : neighbor.homeZ;
            m1MowingLawn.grassTiles = [];
            m1MowingLawn.cutTiles = 0;

            // Create grass tiles grid (lawn is in front of house)
            const startX = m1MowingLawn.houseX - (m1MowingLawn.lawnWidth * m1MowingLawn.tileSize) / 2;
            const startZ = m1MowingLawn.houseZ + 70;

            for (let row = 0; row < m1MowingLawn.lawnHeight; row++) {
                for (let col = 0; col < m1MowingLawn.lawnWidth; col++) {
                    m1MowingLawn.grassTiles.push({
                        x: startX + col * m1MowingLawn.tileSize,
                        z: startZ + row * m1MowingLawn.tileSize,
                        cut: false,
                        grassHeight: 8 + Math.random() * 6
                    });
                }
            }

            m1MowingLawn.totalTiles = m1MowingLawn.grassTiles.length;
            m1MowingLawn.mowerX = startX;
            m1MowingLawn.mowerZ = startZ + m1MowingLawn.lawnHeight * m1MowingLawn.tileSize;
            m1MowingLawn.mowerAngle = 0;

            endConversation();
            showM1Notification(`Mow all the tall grass! Use WASD to move the mower.`, 3000);
        }

        function conversationLemonade() {
            if (!m1ConversationNeighbor) return;
            const neighbor = m1ConversationNeighbor;
            neighbor.mood -= 15;
            neighbor.askCount++;

            if (neighbor.mood <= 0) {
                neighbor.mood = 0;
                document.getElementById('m1-conversation').classList.remove('show');
                showM1Notification(`${neighbor.name} is too annoyed!`, 2000);
                endConversation();
                return;
            }

            document.getElementById('m1-conversation').classList.remove('show');

            // Start neighbor walking to lemonade stand
            neighbor.isWalking = true;
            neighbor.isHome = false;
            neighbor.currentX = neighbor.homeX;
            neighbor.currentZ = neighbor.homeZ + 60;
            m1WalkingNeighbors.push(neighbor);

            endConversation();
            showM1Notification(`${neighbor.name}: "Sure, I'd love some lemonade!"`, 2500);
        }

        function endConversation() {
            if (m1ConversationNeighbor) {
                m1ConversationNeighbor.doorOpen = false;
            }
            m1InConversation = false;
            m1ConversationNeighbor = null;
            m1ConversationPhase = 0;
            document.getElementById('m1-conversation').classList.remove('show');
        }

        function showShopPrompt() {
            m1ShowingPrompt = true;
            const prompt = document.getElementById('m1-prompt');
            const title = document.getElementById('m1-prompt-title');
            const text = document.getElementById('m1-prompt-text');
            const moodDiv = document.getElementById('m1-prompt-mood');
            const buttons = document.getElementById('m1-prompt-buttons');

            title.textContent = "ðŸš€ Rocket Shop";
            text.textContent = "Welcome to the Rocket Shop! Want to buy some parts?";
            moodDiv.innerHTML = '';
            buttons.innerHTML = `
                <button class="m1-prompt-btn shop" onclick="openShop()">Open Shop</button>
                <button class="m1-prompt-btn cancel" onclick="hidePrompt()">Leave</button>
            `;
            prompt.classList.add('show');
        }

        function hidePrompt() {
            document.getElementById('m1-prompt').classList.remove('show');
            m1ShowingPrompt = false;
            m1InteractingNeighbor = null;
        }

        function completeMowing() {
            const pay = m1CurrentMowingNeighbor.mowPay;
            m1Money += pay;
            showM1Notification(`Lawn complete! Earned $${pay}!`, 2500);

            // Reset mowing state
            m1IsMowing = false;
            m1MowingMiniGame = false;
            m1MowingProgress = 0;

            // Restore Noah's position
            noah.x = m1MowingLawn.originalNoahPos.x;
            noah.z = m1MowingLawn.originalNoahPos.z;

            m1CurrentMowingNeighbor = null;
        }

        function askForLemonade() {
            if (!m1InteractingNeighbor) return;

            const neighbor = m1InteractingNeighbor;

            // Decrease mood because we asked
            neighbor.mood -= 15; // Asking for lemonade is more annoying
            neighbor.askCount++;

            if (neighbor.mood <= 0) {
                neighbor.mood = 0;
                showM1Notification(`${neighbor.name} is too annoyed!`, 2000);
                hidePrompt();
                return;
            }

            // Neighbor goes to lemonade stand
            neighbor.atLemonade = true;
            neighbor.isHome = false;
            m1CustomersWaiting++;

            hidePrompt();
            showM1Notification(`${neighbor.name} is heading to the lemonade stand!`, 2000);
            updateM1HUD();
        }

        function openShop() {
            hidePrompt();
            m1IsShopOpen = true;
            const shop = document.getElementById('m1-shop');
            const items = document.getElementById('m1-shop-items');

            let html = '';
            for (let key in m1RocketParts) {
                const part = m1RocketParts[key];
                const canBuy = m1Money >= part.price && !part.owned;
                const owned = part.owned;

                html += `
                    <div class="m1-shop-item ${owned ? 'owned' : ''}">
                        <div class="m1-shop-item-info">
                            <div class="m1-shop-item-icon">${part.icon}</div>
                            <div>
                                <div class="m1-shop-item-name">${part.name}</div>
                                <div class="m1-shop-item-desc">${part.desc}</div>
                            </div>
                        </div>
                        <div class="m1-shop-item-price">$${part.price}</div>
                        <button class="m1-shop-item-btn ${owned ? 'purchased' : ''}"
                                ${canBuy ? '' : 'disabled'}
                                onclick="buyPart('${key}')">
                            ${owned ? 'âœ“ Owned' : 'Buy'}
                        </button>
                    </div>
                `;
            }
            items.innerHTML = html;
            shop.style.display = 'block';
        }

        function closeShop() {
            m1IsShopOpen = false;
            document.getElementById('m1-shop').style.display = 'none';
        }

        function buyPart(partKey) {
            const part = m1RocketParts[partKey];
            if (m1Money >= part.price && !part.owned) {
                m1Money -= part.price;
                part.owned = true;
                showM1Notification(`Bought ${part.name}! ${part.icon}`, 2000);
                updateM1HUD();
                openShop(); // Refresh shop display

                // Check if all parts are owned
                checkM1Victory();
            }
        }

        function checkM1Victory() {
            let allOwned = true;
            for (let key in m1RocketParts) {
                if (!m1RocketParts[key].owned) {
                    allOwned = false;
                    break;
                }
            }

            if (allOwned) {
                // Victory!
                setTimeout(() => {
                    closeShop();
                    gameState = "m1_won";
                    document.getElementById('mission1-hud').style.display = 'none';
                    document.getElementById('mission1-victory').style.display = 'flex';
                    saveProgress(1);
                }, 1000);
            }
        }

        function updateMission1() {
            // Movement - disabled during conversation
            let speed = 5;
            if (!m1IsMowing && !m1IsShopOpen && !m1ShowingPrompt && !m1InConversation) {
                if (keyIsDown(87)) noah.z -= speed; // W
                if (keyIsDown(83)) noah.z += speed; // S
                if (keyIsDown(65)) noah.x -= speed; // A
                if (keyIsDown(68)) noah.x += speed; // D

                // Clamp to neighborhood bounds
                noah.x = constrain(noah.x, -450, 450);
                noah.z = constrain(noah.z, -350, 450);
            }

            // Noah's rotation based on movement
            if (!m1InConversation) {
                let dx = 0, dz = 0;
                if (keyIsDown(87)) dz = -1;
                if (keyIsDown(83)) dz = 1;
                if (keyIsDown(65)) dx = -1;
                if (keyIsDown(68)) dx = 1;
                if (dx !== 0 || dz !== 0) {
                    noah.angle = atan2(dx, dz);
                }
            }

            // Mowing mini-game update
            if (m1MowingMiniGame && m1CurrentMowingNeighbor) {
                updateMowingMiniGame();
            }

            // Update walking neighbors - animate them walking to lemonade stand
            const lemonadeTargetX = m1LemonadeStand.x + 50;
            const lemonadeTargetZ = m1LemonadeStand.z + 30;

            for (let i = m1WalkingNeighbors.length - 1; i >= 0; i--) {
                const neighbor = m1WalkingNeighbors[i];
                const targetX = lemonadeTargetX + (m1DrinkingNeighbors.length * 20);
                const targetZ = lemonadeTargetZ;

                // Move toward lemonade stand
                const dx = targetX - neighbor.currentX;
                const dz = targetZ - neighbor.currentZ;
                const d = Math.sqrt(dx * dx + dz * dz);

                if (d > 5) {
                    const walkSpeed = 2.5;
                    neighbor.currentX += (dx / d) * walkSpeed;
                    neighbor.currentZ += (dz / d) * walkSpeed;
                } else {
                    // Arrived at lemonade stand
                    neighbor.isWalking = false;
                    neighbor.isDrinking = true;
                    neighbor.drinkTimer = 0;
                    neighbor.atLemonade = true;
                    m1CustomersWaiting++;
                    m1WalkingNeighbors.splice(i, 1);
                    m1DrinkingNeighbors.push(neighbor);
                    updateM1HUD();
                }
            }

            // Update drinking neighbors - show them drinking then leave
            for (let i = m1DrinkingNeighbors.length - 1; i >= 0; i--) {
                const neighbor = m1DrinkingNeighbors[i];
                neighbor.drinkTimer++;

                // Drinking takes about 3 seconds (180 frames)
                if (neighbor.drinkTimer >= 180) {
                    // Finished drinking, pay and start walking home
                    const earned = 5;
                    m1LemonadeEarnings += earned;
                    m1Money += earned;
                    m1CustomersWaiting--;

                    neighbor.isDrinking = false;
                    neighbor.atLemonade = false;
                    neighbor.mood = Math.min(100, neighbor.mood + 10);

                    m1DrinkingNeighbors.splice(i, 1);

                    // Walk home
                    neighbor.isWalking = true;
                    const homeNeighbor = neighbor;
                    const walkHomeInterval = setInterval(() => {
                        const hdx = homeNeighbor.x - homeNeighbor.currentX;
                        const hdz = homeNeighbor.z - homeNeighbor.currentZ;
                        const hd = Math.sqrt(hdx * hdx + hdz * hdz);
                        if (hd > 5) {
                            homeNeighbor.currentX += (hdx / hd) * 2.5;
                            homeNeighbor.currentZ += (hdz / hd) * 2.5;
                        } else {
                            homeNeighbor.isWalking = false;
                            homeNeighbor.isHome = true;
                            homeNeighbor.currentX = homeNeighbor.x;
                            homeNeighbor.currentZ = homeNeighbor.z;
                            clearInterval(walkHomeInterval);
                        }
                    }, 16);

                    updateM1HUD();
                    showM1Notification(`+$${earned} from ${neighbor.name}!`, 1500);
                }
            }

            // Slowly restore neighbor moods over time
            if (frameCount % 300 === 0) { // Every 5 seconds
                for (let neighbor of m1Neighbors) {
                    if (neighbor.mood < 100 && neighbor.isHome && !neighbor.isWalking) {
                        neighbor.mood = Math.min(100, neighbor.mood + 3);
                    }
                }
            }

            // Update tooltip (not during conversation)
            if (!m1InConversation) {
                updateM1Tooltip();
            } else {
                document.getElementById('m1-tooltip').classList.remove('show');
            }
        }

        function drawMission1Scene() {
            // Sky gradient effect (light blue)
            background(135, 206, 235);

            // Camera - conversation mode zooms to the house
            if (m1InConversation && m1ConversationNeighbor) {
                const n = m1ConversationNeighbor;
                // Smooth camera interpolation
                m1CameraPos.x = lerp(m1CameraPos.x, n.homeX, 0.1);
                m1CameraPos.z = lerp(m1CameraPos.z, n.homeZ + 150, 0.1);
                camera(m1CameraPos.x, -200, m1CameraPos.z, n.homeX, -30, n.homeZ + 50, 0, 1, 0);
            } else {
                // Normal isometric view
                camera(noah.x, -400, noah.z + 350, noah.x, 0, noah.z, 0, 1, 0);
            }

            // Lighting
            ambientLight(120);
            directionalLight(255, 255, 200, 0.5, 1, -0.3);

            // Draw ground (grass)
            push();
            rotateX(HALF_PI);
            fill(34, 139, 34); // Forest green
            plane(1200, 1000);
            pop();

            // Draw roads
            drawM1Roads();

            // Draw lake behind houses
            drawM1Lake();

            // Draw houses
            for (let house of m1Houses) {
                drawM1House(house);
            }

            // Draw trees
            for (let tree of m1Trees) {
                drawM1Tree(tree);
            }

            // Draw flowers
            for (let flower of m1Flowers) {
                drawM1Flower(flower);
            }

            // Draw lemonade stand with Hannah
            drawLemonadeStand();

            // Draw rocket shop
            drawRocketShop();

            // Draw neighbors (home, walking, or drinking)
            for (let neighbor of m1Neighbors) {
                if (neighbor.isHome || neighbor.isWalking || neighbor.isDrinking || neighbor.atLemonade) {
                    drawM1Neighbor(neighbor);
                }
            }

            // Draw Noah
            drawM1Noah();

            // Draw mowing progress bar if mowing
            if (m1IsMowing) {
                drawMowingProgress();
            }
        }

        function drawM1Roads() {
            fill(80, 80, 80);

            // Belle Pond Ave - gentle curved street with houses on one side
            const roadWidth = 45;
            const roadY = -0.5;

            // Main curved road - runs from left to right with slight curve
            // Left section
            push();
            translate(-200, roadY, 80);
            rotateX(HALF_PI);
            box(150, roadWidth, 1);
            pop();

            // Center-left curve
            push();
            translate(-80, roadY, 95);
            rotateX(HALF_PI);
            rotateZ(0.15);
            box(120, roadWidth, 1);
            pop();

            // Center section (in front of The Rudys)
            push();
            translate(30, roadY, 105);
            rotateX(HALF_PI);
            box(130, roadWidth, 1);
            pop();

            // Center-right curve
            push();
            translate(140, roadY, 95);
            rotateX(HALF_PI);
            rotateZ(-0.15);
            box(120, roadWidth, 1);
            pop();

            // Right section leading to lake/rocket shop
            push();
            translate(260, roadY, 80);
            rotateX(HALF_PI);
            box(150, roadWidth, 1);
            pop();

            // Cul-de-sac turnaround at the end (near lake)
            push();
            translate(350, roadY, 100);
            rotateX(HALF_PI);
            ellipse(0, 0, 80, 80);
            pop();

            // Entrance from main road (left side)
            push();
            translate(-320, roadY, 50);
            rotateX(HALF_PI);
            box(100, roadWidth, 1);
            pop();

            // Curve connecting entrance to Belle Pond Ave
            push();
            translate(-260, roadY, 65);
            rotateX(HALF_PI);
            rotateZ(-0.4);
            box(60, roadWidth, 1);
            pop();
        }

        function drawM1Lake() {
            // Lake behind the houses (north side)
            push();
            translate(m1Lake.x, -1, m1Lake.z);

            // Main lake body - dark blue water
            fill(30, 100, 180, 200);
            rotateX(HALF_PI);
            ellipse(0, 0, m1Lake.width, m1Lake.height);

            // Lighter water highlight in center
            fill(60, 140, 210, 180);
            ellipse(0, 10, m1Lake.width * 0.6, m1Lake.height * 0.5);

            // Water ripple effect (subtle)
            noFill();
            stroke(100, 180, 230, 100);
            strokeWeight(2);
            ellipse(30, -20, 80, 40);
            ellipse(-50, 15, 60, 30);
            noStroke();

            pop();

            // Lake shore/beach area
            push();
            translate(m1Lake.x, -0.3, m1Lake.z - 30);
            fill(210, 180, 140); // Sandy color
            rotateX(HALF_PI);
            ellipse(0, 0, m1Lake.width + 40, 60);
            pop();
        }

        function drawM1House(house) {
            push();
            translate(house.x, 0, house.z);

            // Rotate house based on facing direction
            // Default faces +z (south), so rotate for other directions
            if (house.facingSouth) {
                rotateY(PI); // Face toward -z (south toward road)
            } else if (house.facingEast) {
                rotateY(HALF_PI); // Face toward +x (east toward road)
            } else if (house.facingWest) {
                rotateY(-HALF_PI); // Face toward -x (west toward road)
            }
            // Default (no facing set) faces +z

            // House base
            fill(house.color[0], house.color[1], house.color[2]);
            push();
            translate(0, -30, 0);
            box(80, 60, 60);
            pop();

            // Roof - Peaked roof (slopes DOWN from center)
            fill(house.roofColor[0], house.roofColor[1], house.roofColor[2]);

            // Left roof slope - slopes down to the left
            push();
            translate(-22, -75, 0);
            rotateZ(-0.6); // Negative = left side tilts down
            box(50, 5, 68);
            pop();

            // Right roof slope - slopes down to the right
            push();
            translate(22, -75, 0);
            rotateZ(0.6); // Positive = right side tilts down
            box(50, 5, 68);
            pop();

            // Roof ridge cap at the peak (darker)
            push();
            translate(0, -88, 0);
            fill(house.roofColor[0] * 0.7, house.roofColor[1] * 0.7, house.roofColor[2] * 0.7);
            box(12, 6, 72);
            pop();

            // Front gable wall (triangular area under roof)
            push();
            translate(0, -60, 30.5);
            fill(house.color[0], house.color[1], house.color[2]);
            // Approximate triangle with narrow boxes stacked
            for (let i = 0; i < 8; i++) {
                push();
                translate(0, -i * 3.5, 0);
                box(80 - i * 10, 4, 2);
                pop();
            }
            pop();

            // Back gable wall
            push();
            translate(0, -60, -30.5);
            fill(house.color[0] * 0.9, house.color[1] * 0.9, house.color[2] * 0.9);
            for (let i = 0; i < 8; i++) {
                push();
                translate(0, -i * 3.5, 0);
                box(80 - i * 10, 4, 2);
                pop();
            }
            pop();

            // Small attic window on front gable
            push();
            translate(0, -72, 32);
            fill(180, 220, 255);
            box(10, 10, 2);
            // Window frame
            fill(255);
            translate(0, 0, 1);
            box(12, 2, 1);
            box(2, 12, 1);
            pop();

            // Door - check if owner has door open
            const isDoorOpen = house.owner && house.owner.doorOpen;
            fill(101, 67, 33);
            push();
            if (isDoorOpen) {
                // Open door - show dark interior and door swung open
                // Dark doorway
                fill(30, 20, 15);
                translate(0, -15, 30);
                box(15, 30, 2);
                // Door swung open
                fill(101, 67, 33);
                push();
                translate(-8, 0, 5);
                rotateY(1.2); // Open angle
                box(15, 30, 2);
                // Door handle
                fill(200, 180, 50);
                translate(5, 0, 2);
                sphere(2);
                pop();
            } else {
                // Closed door
                translate(0, -15, 31);
                box(15, 30, 2);
                // Door handle
                fill(200, 180, 50);
                translate(5, 0, 2);
                sphere(2);
            }
            pop();

            // Windows
            fill(135, 206, 250);
            push();
            translate(-20, -35, 31);
            box(12, 12, 2);
            // Window frame
            fill(255);
            translate(0, 0, 1);
            box(14, 2, 1);
            box(2, 14, 1);
            pop();
            push();
            translate(20, -35, 31);
            box(12, 12, 2);
            fill(255);
            translate(0, 0, 1);
            box(14, 2, 1);
            box(2, 14, 1);
            pop();

            // Lawn (slightly different green)
            fill(50, 180, 50);
            push();
            translate(0, -0.5, 50);
            rotateX(HALF_PI);
            ellipse(0, 0, 100, 80);
            pop();

            // Mailbox with name
            push();
            translate(35, 0, 60);
            // Post
            fill(80, 50, 30);
            push();
            translate(0, -15, 0);
            box(3, 30, 3);
            pop();
            // Mailbox
            fill(50, 50, 200);
            push();
            translate(0, -32, 0);
            box(12, 8, 8);
            pop();
            // Name plate
            fill(255, 250, 220);
            push();
            translate(0, -25, 5);
            box(20, 8, 1);
            pop();
            pop();

            // Chimney
            push();
            translate(25, -75, -10);
            fill(150, 80, 60);
            box(12, 25, 12);
            pop();

            pop();
        }

        function drawM1Tree(tree) {
            push();
            translate(tree.x, 0, tree.z);

            // Trunk
            fill(101, 67, 33);
            push();
            translate(0, -tree.height / 4, 0);
            cylinder(5, tree.height / 2);
            pop();

            // Leaves (multiple spheres)
            fill(34, 120, 34);
            push();
            translate(0, -tree.height * 0.6, 0);
            sphere(tree.width / 2);
            translate(0, -tree.width / 4, 0);
            sphere(tree.width / 3);
            pop();

            pop();
        }

        function drawM1Flower(flower) {
            push();
            translate(flower.x, -3, flower.z);
            fill(flower.color[0], flower.color[1], flower.color[2]);
            sphere(3);
            // Stem
            fill(34, 139, 34);
            translate(0, 2, 0);
            cylinder(0.5, 4);
            pop();
        }

        function drawLemonadeStand() {
            push();
            translate(m1LemonadeStand.x, 0, m1LemonadeStand.z);

            // Stand table
            fill(139, 90, 43);
            push();
            translate(0, -25, 0);
            box(60, 5, 30);
            pop();

            // Legs
            fill(101, 67, 33);
            for (let lx of [-25, 25]) {
                for (let lz of [-10, 10]) {
                    push();
                    translate(lx, -12, lz);
                    box(4, 25, 4);
                    pop();
                }
            }

            // Pitcher
            fill(255, 255, 100);
            push();
            translate(-10, -35, 0);
            cylinder(8, 15);
            pop();

            // Cups on the counter
            fill(255, 255, 220);
            for (let c = 0; c < 3; c++) {
                push();
                translate(5 + c * 12, -32, 0);
                cylinder(4, 8);
                pop();
            }

            // Sign post
            fill(101, 67, 33);
            push();
            translate(0, -45, -15);
            box(4, 40, 4);
            pop();

            // Sign board
            fill(255, 255, 200);
            push();
            translate(0, -70, -15);
            box(70, 25, 3);
            pop();

            // "LEMONADE" text (yellow banner)
            fill(255, 220, 0);
            push();
            translate(0, -70, -13);
            box(60, 15, 1);
            pop();

            // Draw Hannah TO THE SIDE of the stand (visible!)
            push();
            translate(-50, 0, 10);
            drawM1Hannah();
            pop();

            pop();
        }

        function drawM1Hannah() {
            push();

            // Pink dress body
            fill(255, 105, 180);
            push();
            translate(0, -18, 0);
            box(14, 24, 12);
            pop();

            // Head
            push();
            translate(0, -38, 0);
            fill(255, 220, 180);
            sphere(8);

            // Brown hair (longer for girl)
            fill(139, 69, 19);
            push();
            translate(0, -2, -2);
            sphere(9);
            // Hair going down
            translate(0, 5, -3);
            box(16, 12, 4);
            pop();

            // Eyes
            fill(50, 50, 50);
            push();
            translate(-3, 0, 7);
            sphere(1.5);
            translate(6, 0, 0);
            sphere(1.5);
            pop();

            // Smile
            fill(200, 100, 100);
            push();
            translate(0, 3, 7);
            box(4, 1, 1);
            pop();
            pop();

            // Arms - one waving, one on hip
            fill(255, 220, 180);
            push();
            translate(-12, -25, 0);
            rotateZ(0.8 + sin(frameCount * 0.15) * 0.4); // Waving!
            box(4, 14, 4);
            pop();
            push();
            translate(12, -20, 0);
            rotateZ(-0.5);
            box(4, 12, 4);
            pop();

            // Legs
            fill(255, 200, 180);
            push();
            translate(-4, -4, 0);
            box(5, 10, 5);
            pop();
            push();
            translate(4, -4, 0);
            box(5, 10, 5);
            pop();

            pop();
        }

        function drawRocketShop() {
            push();
            translate(m1RocketShop.x, 0, m1RocketShop.z);

            // Shop building
            fill(60, 60, 80);
            push();
            translate(0, -40, 0);
            box(100, 80, 80);
            pop();

            // Roof
            fill(40, 40, 60);
            push();
            translate(0, -85, 0);
            box(110, 10, 90);
            pop();

            // Door
            fill(100, 150, 255);
            push();
            translate(0, -25, 41);
            box(25, 50, 2);
            pop();

            // Rocket sign
            fill(255, 100, 50);
            push();
            translate(0, -90, 0);
            // Simplified rocket
            cylinder(8, 30);
            translate(0, -20, 0);
            cone(10, 15);
            pop();

            // "SHOP" sign
            fill(255, 255, 0);
            push();
            translate(0, -70, 42);
            box(60, 15, 2);
            pop();

            pop();
        }

        function drawM1Neighbor(neighbor) {
            // Use currentX/Z for animated position, fallback to home position
            let posX, posZ;

            // During conversation, neighbor stands at their door
            if (neighbor.doorOpen && m1InConversation) {
                posX = neighbor.homeX;
                posZ = neighbor.homeZ + 45; // In front of door
            } else if (neighbor.isWalking || neighbor.isDrinking) {
                posX = neighbor.currentX;
                posZ = neighbor.currentZ;
            } else if (neighbor.isHome) {
                posX = neighbor.x;
                posZ = neighbor.z;
            } else {
                return; // Don't draw if not visible
            }

            push();
            translate(posX, 0, posZ);

            // Walking animation - leg movement
            let legSwing = 0;
            if (neighbor.isWalking) {
                legSwing = sin(frameCount * 0.3) * 0.5;
            }

            // Body
            fill(neighbor.shirtColor[0], neighbor.shirtColor[1], neighbor.shirtColor[2]);
            push();
            translate(0, -20, 0);
            box(15, 25, 12);
            pop();

            // Pants
            fill(neighbor.pantsColor ? neighbor.pantsColor[0] : 60,
                 neighbor.pantsColor ? neighbor.pantsColor[1] : 60,
                 neighbor.pantsColor ? neighbor.pantsColor[2] : 80);
            push();
            translate(-4, -5, 0);
            rotateX(legSwing);
            box(6, 12, 6);
            pop();
            push();
            translate(4, -5, 0);
            rotateX(-legSwing);
            box(6, 12, 6);
            pop();

            // Head
            push();
            translate(0, -40, 0);
            fill(255, 220, 180);
            sphere(8);

            // Hair
            fill(neighbor.hairColor[0], neighbor.hairColor[1], neighbor.hairColor[2]);
            push();
            translate(0, -4, -1);
            scale(1, 0.5, 1);
            sphere(9);
            pop();
            pop();

            // Arms - drinking animation
            fill(255, 220, 180);
            if (neighbor.isDrinking) {
                // Drinking - arm raised with cup
                let drinkCycle = sin(neighbor.drinkTimer * 0.1) * 0.3;
                push();
                translate(-10, -25, 0);
                rotateZ(0.3);
                box(4, 12, 4);
                pop();
                // Right arm holding cup to mouth
                push();
                translate(10, -30, 5);
                rotateZ(-1.2 + drinkCycle);
                rotateX(-0.5);
                box(4, 12, 4);
                // Cup in hand
                fill(255, 255, 200);
                translate(0, -8, 0);
                cylinder(3, 6);
                // Lemonade in cup
                fill(255, 255, 100);
                translate(0, 1, 0);
                cylinder(2.5, 4);
                pop();
            } else {
                // Normal arms
                push();
                translate(-10, -22, 0);
                rotateZ(0.2 + (neighbor.isWalking ? sin(frameCount * 0.3 + PI) * 0.3 : 0));
                box(4, 12, 4);
                pop();
                push();
                translate(10, -22, 0);
                rotateZ(-0.2 + (neighbor.isWalking ? sin(frameCount * 0.3) * 0.3 : 0));
                box(4, 12, 4);
                pop();
            }

            pop();
        }

        function drawM1Noah() {
            push();

            // During conversation, position Noah facing the neighbor
            if (m1InConversation && m1ConversationNeighbor) {
                const n = m1ConversationNeighbor;
                translate(n.homeX, 0, n.homeZ + 90); // In front of neighbor
                rotateY(PI); // Face the neighbor (toward the house)
            } else {
                translate(noah.x, 0, noah.z);
                rotateY(noah.angle);
            }

            // Body (blue shirt)
            fill(0, 100, 255);
            push();
            translate(0, -18, 0);
            box(14, 22, 10);
            pop();

            // Head
            push();
            translate(0, -35, 0);
            fill(255, 220, 180);
            sphere(8);

            // Blonde hair
            fill(255, 220, 0);
            translate(0, -4, 0);
            box(17, 6, 16);
            pop();

            // Legs
            fill(50, 50, 150);
            push();
            translate(-4, -4, 0);
            let legSwing = sin(frameCount * 0.2) * 0.3;
            rotateX(legSwing);
            box(5, 14, 5);
            pop();
            push();
            translate(4, -4, 0);
            rotateX(-legSwing);
            box(5, 14, 5);
            pop();

            // Arms
            fill(255, 220, 180);
            push();
            translate(-10, -20, 0);
            let armSwing = sin(frameCount * 0.2 + PI) * 0.4;
            rotateX(armSwing);
            box(4, 14, 4);
            pop();
            push();
            translate(10, -20, 0);
            rotateX(-armSwing);
            box(4, 14, 4);
            pop();

            pop();
        }

        function updateMowingMiniGame() {
            let speed = 3, moving = false;
            if (keyIsDown(87)) { m1MowingLawn.mowerZ -= speed; m1MowingLawn.mowerAngle = 0; moving = true; }
            if (keyIsDown(83)) { m1MowingLawn.mowerZ += speed; m1MowingLawn.mowerAngle = PI; moving = true; }
            if (keyIsDown(65)) { m1MowingLawn.mowerX -= speed; m1MowingLawn.mowerAngle = -HALF_PI; moving = true; }
            if (keyIsDown(68)) { m1MowingLawn.mowerX += speed; m1MowingLawn.mowerAngle = HALF_PI; moving = true; }

            // Clamp mower to lawn bounds
            const minX = m1MowingLawn.houseX - (m1MowingLawn.lawnWidth * m1MowingLawn.tileSize) / 2 - 15;
            const maxX = m1MowingLawn.houseX + (m1MowingLawn.lawnWidth * m1MowingLawn.tileSize) / 2 + 15;
            const minZ = m1MowingLawn.houseZ + 70 - 15;
            const maxZ = m1MowingLawn.houseZ + 70 + m1MowingLawn.lawnHeight * m1MowingLawn.tileSize + 30;
            m1MowingLawn.mowerX = constrain(m1MowingLawn.mowerX, minX, maxX);
            m1MowingLawn.mowerZ = constrain(m1MowingLawn.mowerZ, minZ, maxZ);

            if (moving) {
                for (let t of m1MowingLawn.grassTiles) {
                    if (!t.cut && Math.hypot(m1MowingLawn.mowerX - t.x, m1MowingLawn.mowerZ - t.z) < m1MowingLawn.tileSize * 0.9) {
                        t.cut = true;
                        m1MowingLawn.cutTiles++;
                        if (m1MowingLawn.cutTiles >= m1MowingLawn.totalTiles) { completeMowing(); updateM1HUD(); }
                    }
                }
            }
            m1MowingProgress = (m1MowingLawn.cutTiles / m1MowingLawn.totalTiles) * 100;
        }

        function drawMowingMiniGame() {
            camera(m1MowingLawn.houseX, -280, m1MowingLawn.houseZ + 120, m1MowingLawn.houseX, 0, m1MowingLawn.houseZ + 120, 0, 0, -1);

            // Lawn base
            push();
            translate(m1MowingLawn.houseX, 0.5, m1MowingLawn.houseZ + 120);
            rotateX(HALF_PI);
            fill(80, 160, 80);
            plane(m1MowingLawn.lawnWidth * m1MowingLawn.tileSize + 60, m1MowingLawn.lawnHeight * m1MowingLawn.tileSize + 60);
            pop();

            // Tall grass tiles
            for (let t of m1MowingLawn.grassTiles) {
                if (!t.cut) {
                    push();
                    translate(t.x, 0, t.z);
                    for (let i = 0; i < 5; i++) {
                        push();
                        translate((i % 3 - 1) * 5, -t.grassHeight / 2, (Math.floor(i / 3) - 0.5) * 4);
                        rotateZ(sin(frameCount * 0.08 + i + t.x * 0.05) * 0.12);
                        fill(20 + i * 8, 100 + i * 15, 20);
                        box(3, t.grassHeight, 3);
                        translate(0, -t.grassHeight / 2 - 2, 0);
                        fill(40, 130, 40);
                        cone(2, 5);
                        pop();
                    }
                    pop();
                }
            }

            // Lawn mower with Noah
            push();
            translate(m1MowingLawn.mowerX, 0, m1MowingLawn.mowerZ);
            rotateY(m1MowingLawn.mowerAngle);

            // Mower body (red)
            fill(220, 50, 50);
            push(); translate(0, -10, 0); box(24, 12, 30); pop();
            // Mower deck
            fill(60);
            push(); translate(0, -3, 0); box(28, 4, 34); pop();
            // Wheels
            fill(30);
            for (let wx of [-12, 12]) {
                for (let wz of [-12, 12]) {
                    push(); translate(wx, -5, wz); rotateZ(HALF_PI); cylinder(5, 4); pop();
                }
            }
            // Handle
            fill(100);
            push(); translate(0, -18, 20); rotateX(-0.4); box(4, 25, 4); pop();
            fill(40);
            push(); translate(0, -32, 28); box(30, 4, 4); pop();

            // Noah pushing mower
            push();
            translate(0, 0, 40);
            let legSwing = sin(frameCount * 0.3) * 0.4;
            // Legs
            fill(50, 50, 150);
            push(); translate(-5, -8, 0); rotateX(legSwing); box(5, 16, 5); pop();
            push(); translate(5, -8, 0); rotateX(-legSwing); box(5, 16, 5); pop();
            // Body
            fill(0, 100, 255);
            push(); translate(0, -25, 0); box(16, 22, 12); pop();
            // Arms reaching forward
            fill(255, 220, 180);
            push(); translate(-10, -28, -10); rotateX(-0.6); box(4, 18, 4); pop();
            push(); translate(10, -28, -10); rotateX(-0.6); box(4, 18, 4); pop();
            // Head
            push();
            translate(0, -42, 0);
            sphere(9);
            fill(255, 220, 0);
            translate(0, -5, 0);
            box(18, 7, 16);
            pop();
            pop(); // Noah

            pop(); // Mower group

            // House in background
            push();
            translate(m1MowingLawn.houseX, 0, m1MowingLawn.houseZ - 20);
            fill(220, 200, 180);
            push(); translate(0, -30, 0); box(80, 60, 60); pop();
            // Roof - slopes down from center peak
            fill(139, 69, 19);
            push(); translate(-22, -75, 0); rotateZ(-0.6); box(50, 5, 68); pop();
            push(); translate(22, -75, 0); rotateZ(0.6); box(50, 5, 68); pop();
            pop();

            // Progress bar
            push();
            translate(m1MowingLawn.houseX, -100, m1MowingLawn.houseZ + 200);
            fill(50);
            box(160, 18, 4);
            let progressWidth = (m1MowingLawn.cutTiles / m1MowingLawn.totalTiles) * 155;
            fill(0, 220, 0);
            push(); translate(-77.5 + progressWidth / 2, 0, 2); box(progressWidth, 14, 3); pop();
            push();
            translate(0, 20, 0);
            fill(255);
            textSize(12);
            textAlign(CENTER);
            text(Math.floor(m1MowingProgress) + "% - Mow all the grass!", 0, 0);
            pop();
            pop();
        }

        function drawMowingProgress() {
            if (m1MowingMiniGame) return;
        }

        // Check for nearby interactable objects
        function checkM1Interactions() {
            if (m1ShowingPrompt || m1IsShopOpen || m1IsMowing || m1InConversation) return null;

            // Check neighbors directly
            for (let neighbor of m1Neighbors) {
                if (neighbor.isHome && !neighbor.atLemonade) {
                    let d = dist(noah.x, noah.z, neighbor.x, neighbor.z);
                    if (d < 50) {
                        return {
                            type: 'neighbor',
                            data: neighbor,
                            tooltip: `talk to ${neighbor.name}`
                        };
                    }
                }
            }

            // Check houses (can interact even if neighbor is away)
            for (let house of m1Houses) {
                let d = dist(noah.x, noah.z, house.x, house.z + 50); // Front of house
                if (d < 70) {
                    const neighbor = house.owner;
                    if (neighbor.atLemonade) {
                        return {
                            type: 'house_empty',
                            data: neighbor,
                            tooltip: `${neighbor.name}'s house (away at lemonade stand)`
                        };
                    } else if (neighbor.mood <= 20) {
                        return {
                            type: 'house_angry',
                            data: neighbor,
                            tooltip: `knock on ${neighbor.name}'s door (they're annoyed!)`
                        };
                    } else {
                        return {
                            type: 'house',
                            data: neighbor,
                            tooltip: `knock on ${neighbor.name}'s door`
                        };
                    }
                }
            }

            // Check rocket shop
            let shopDist = dist(noah.x, noah.z, m1RocketShop.x, m1RocketShop.z + 40);
            if (shopDist < 80) {
                return {
                    type: 'shop',
                    tooltip: 'enter Rocket Shop'
                };
            }

            // Check lemonade stand
            let standDist = dist(noah.x, noah.z, m1LemonadeStand.x, m1LemonadeStand.z);
            if (standDist < 60) {
                return {
                    type: 'lemonade_stand',
                    tooltip: `check on Hannah (Customers: ${m1CustomersWaiting})`
                };
            }

            return null;
        }

        // Update tooltip display
        function updateM1Tooltip() {
            const tooltip = document.getElementById('m1-tooltip');

            if (m1ShowingPrompt || m1IsShopOpen || m1IsMowing) {
                tooltip.classList.remove('show');
                return;
            }

            const interaction = checkM1Interactions();

            if (interaction && interaction.tooltip) {
                tooltip.innerHTML = `Press <span class="key">E</span> to ${interaction.tooltip}`;
                tooltip.classList.add('show');
            } else {
                tooltip.classList.remove('show');
            }
        }

        // --- LOCAL STORAGE FOR PROGRESS ---
        function loadProgress() {
            try {
                const saved = localStorage.getItem('noahSpaceAdventure');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.log('Could not load progress');
            }
            return { completedMissions: [] };
        }

        function saveProgress(missionNumber) {
            try {
                const progress = loadProgress();
                if (!progress.completedMissions.includes(missionNumber)) {
                    progress.completedMissions.push(missionNumber);
                }
                localStorage.setItem('noahSpaceAdventure', JSON.stringify(progress));
                updateMenuDisplay();
            } catch (e) {
                console.log('Could not save progress');
            }
        }

        function updateMenuDisplay() {
            const progress = loadProgress();
            document.querySelectorAll('.mission-card').forEach(card => {
                const missionNum = parseInt(card.dataset.mission);
                if (progress.completedMissions.includes(missionNum)) {
                    card.classList.add('completed');
                    const status = card.querySelector('.mission-card-status');
                    if (status && missionNum === 3) {
                        status.textContent = 'Completed!';
                    }
                }
            });
        }

        // Initialize menu display on load
        document.addEventListener('DOMContentLoaded', updateMenuDisplay);
        updateMenuDisplay();

        // --- MISSION START ---
        function startMission(missionNumber) {
            currentMission = missionNumber;

            if (missionNumber === 1) {
                // Mission 1: Build the Rocket
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('mission1-intro').style.display = 'flex';
                gameState = "m1_intro";

                initMission1();

                // Auto-advance after 3 seconds
                introTimeout = setTimeout(() => {
                    if (gameState === "m1_intro") {
                        document.getElementById('mission1-intro').style.display = 'none';
                        document.getElementById('mission1-cutscene').style.display = 'flex';
                        gameState = "m1_cutscene";
                    }
                }, 3000);
            } else if (missionNumber === 3) {
                // Hide menu, show mission intro
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('mission-intro').style.display = 'flex';
                gameState = "intro";

                // Auto-advance after 3 seconds
                introTimeout = setTimeout(() => {
                    if (gameState === "intro") {
                        document.getElementById('mission-intro').style.display = 'none';
                        document.getElementById('cutscene').style.display = 'flex';
                        gameState = "cutscene";
                    }
                }, 3000);
            }
        }

        function returnToMenu() {
            // Reset game state
            gameState = "menu";
            currentMission = 0;
            repairProgress = 0;
            hannahHealth = 100;
            noah.x = 0; noah.z = 0;
            aliens = [];
            bullets = [];

            // Hide all screens, show menu
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('victory-cutscene').style.display = 'none';
            document.getElementById('mission-intro').style.display = 'none';
            document.getElementById('cutscene').style.display = 'none';
            document.getElementById('ui-layer').style.opacity = '0';
            document.getElementById('main-menu').style.display = 'flex';
            document.getElementById('hp-val').innerText = "100";

            // Hide Mission 1 screens
            document.getElementById('mission1-intro').style.display = 'none';
            document.getElementById('mission1-cutscene').style.display = 'none';
            document.getElementById('mission1-hud').style.display = 'none';
            document.getElementById('mission1-victory').style.display = 'none';

            // Update menu to show completed missions
            updateMenuDisplay();
        }

        // Hide UI layer and mission intro initially (menu is shown first)
        document.getElementById('ui-layer').style.opacity = '0';
        document.getElementById('mission-intro').style.display = 'none';
        document.getElementById('mission1-intro').style.display = 'none';
        document.getElementById('mission1-cutscene').style.display = 'none';
        document.getElementById('mission1-hud').style.display = 'none';
        document.getElementById('mission1-victory').style.display = 'none';

        // Click handler for intro/cutscene
        document.addEventListener('click', function(e) {
            // Mission 1 intro/cutscene handling
            if (gameState === "m1_intro") {
                if (introTimeout) clearTimeout(introTimeout);
                document.getElementById('mission1-intro').style.display = 'none';
                document.getElementById('mission1-cutscene').style.display = 'flex';
                gameState = "m1_cutscene";
            } else if (gameState === "m1_cutscene") {
                document.getElementById('mission1-cutscene').style.display = 'none';
                document.getElementById('mission1-hud').style.display = 'flex';
                gameState = "m1_playing";
            }
            // Mission 3 intro/cutscene handling
            else if (gameState === "intro") {
                if (introTimeout) clearTimeout(introTimeout);
                document.getElementById('mission-intro').style.display = 'none';
                document.getElementById('cutscene').style.display = 'flex';
                gameState = "cutscene";
            } else if (gameState === "cutscene") {
                document.getElementById('cutscene').style.display = 'none';
                document.getElementById('ui-layer').style.opacity = '1';
                gameState = "playing";
            }
        }, { capture: true });

        // --- ENTITIES ---
        let noah = { x: 0, z: 0, angle: 0, swingTimer: 0 };
        let bullets = [];
        let aliens = [];
        let particles = []; // For explosions/dust

        // --- MARS TERRAIN ---
        let rocks = [];
        let craters = [];
        let dunes = [];
        let pebbles = [];

        // --- ASSETS (Procedural) ---
        // We will draw everything with code (Boxes/Spheres)

        function setup() {
            createCanvas(window.innerWidth, window.innerHeight, WEBGL);
            noStroke();
            generateTerrain();
        }

        function generateTerrain() {
            // Generate rocks (various sizes scattered around)
            for (let i = 0; i < 60; i++) {
                let angle = random(TWO_PI);
                let dist = random(150, 800);
                rocks.push({
                    x: cos(angle) * dist,
                    z: sin(angle) * dist,
                    size: random(8, 35),
                    height: random(10, 40),
                    rotation: random(TWO_PI),
                    tilt: random(-0.2, 0.2),
                    color: random([
                        [160, 50, 35],
                        [140, 45, 30],
                        [180, 65, 45],
                        [120, 40, 25],
                        [100, 35, 20]
                    ])
                });
            }

            // Generate craters
            for (let i = 0; i < 15; i++) {
                let angle = random(TWO_PI);
                let dist = random(200, 700);
                craters.push({
                    x: cos(angle) * dist,
                    z: sin(angle) * dist,
                    radius: random(30, 80),
                    depth: random(3, 8)
                });
            }

            // Generate dunes/hills
            for (let i = 0; i < 25; i++) {
                let angle = random(TWO_PI);
                let dist = random(100, 900);
                dunes.push({
                    x: cos(angle) * dist,
                    z: sin(angle) * dist,
                    width: random(60, 150),
                    height: random(5, 20),
                    length: random(80, 200),
                    rotation: random(TWO_PI)
                });
            }

            // Generate small pebbles for detail
            for (let i = 0; i < 200; i++) {
                let angle = random(TWO_PI);
                let dist = random(50, 900);
                pebbles.push({
                    x: cos(angle) * dist,
                    z: sin(angle) * dist,
                    size: random(2, 6),
                    color: random([
                        [150, 55, 40],
                        [130, 40, 28],
                        [170, 60, 42]
                    ])
                });
            }
        }

        function drawMarsTerrain() {
            // Base ground plane with gradient effect (multiple layers)
            push();
            rotateX(HALF_PI);
            fill(180, 60, 40); // Mars Red base
            plane(3000, 3000);
            pop();

            // Draw darker patches on ground for variety
            for (let i = 0; i < 8; i++) {
                push();
                let px = (i % 4 - 1.5) * 400;
                let pz = (Math.floor(i / 4) - 0.5) * 400;
                translate(px, -3, pz);
                rotateX(HALF_PI);
                fill(160, 50, 35, 150);
                ellipse(0, 0, 300, 250);
                pop();
            }

            // Draw dunes/hills
            dunes.forEach(d => {
                push();
                translate(d.x, -d.height / 2, d.z);
                rotateY(d.rotation);
                fill(190, 70, 50);
                scale(1, 0.4, 1);
                sphere(d.width / 2);
                pop();
            });

            // Draw craters
            craters.forEach(c => {
                push();
                translate(c.x, 0, c.z);

                // Crater depression (bowl shape using flattened sphere)
                fill(90, 28, 18);
                push();
                translate(0, c.depth, 0);
                scale(1, 0.15, 1);
                sphere(c.radius * 0.9);
                pop();

                // Outer rim (raised edge)
                fill(170, 55, 38);
                translate(0, -c.depth - 2, 0);
                rotateX(HALF_PI);
                torus(c.radius, c.depth + 2);
                pop();
            });

            // Draw rocks
            rocks.forEach(r => {
                push();
                translate(r.x, -r.height / 2, r.z);
                rotateY(r.rotation);
                rotateX(r.tilt); // Slight tilt for variety
                fill(r.color[0], r.color[1], r.color[2]);

                // Make rocks look more natural with stacked shapes
                // Main body
                scale(1, r.height / r.size, 1);
                sphere(r.size);

                // Add a smaller rock on top sometimes
                if (r.size > 20) {
                    translate(r.size * 0.3, -r.size * 0.6, 0);
                    scale(0.5);
                    fill(r.color[0] - 20, r.color[1] - 10, r.color[2] - 10);
                    sphere(r.size * 0.6);
                }
                pop();
            });

            // Draw pebbles
            pebbles.forEach(p => {
                push();
                translate(p.x, -p.size / 2, p.z);
                fill(p.color[0], p.color[1], p.color[2]);
                sphere(p.size);
                pop();
            });

            // Add some dust/sand ripples near the ground
            for (let i = 0; i < 12; i++) {
                push();
                let angle = (i / 12) * TWO_PI;
                let dist = 200 + (i % 3) * 150;
                translate(cos(angle) * dist, -4, sin(angle) * dist);
                rotateX(HALF_PI);
                rotateZ(angle + HALF_PI);
                noFill();
                stroke(200, 80, 55, 100);
                strokeWeight(2);
                arc(0, 0, 80, 40, 0, PI);
                noStroke();
                pop();
            }
        }

        function draw() {
            // -- MISSION 1 --
            if (gameState === "m1_playing") {
                updateMission1();
                if (m1MowingMiniGame) {
                    drawMowingMiniGame();
                } else {
                    drawMission1Scene();
                }
                return;
            }

            // -- LOGIC UPDATE --
            if (gameState === "playing") {
                updateGame();
            }

            // Skip 3D rendering for non-gameplay states (except Mission 1 which handles its own)
            if (gameState !== "playing" && gameState !== "won" && gameState !== "lost") {
                background(50, 20, 10);
                return;
            }

            // -- RENDER --
            background(50, 20, 10); // Dark Red Mars Sky

            // Camera Logic: Isometric view following Noah lightly
            // camera(x, y, z, centerX, centerY, centerZ, upX, upY, upZ)
            camera(noah.x, -600, noah.z + 500, noah.x, 0, noah.z, 0, 1, 0);

            // Lighting
            ambientLight(80);
            directionalLight(255, 200, 150, 0.5, 1, -0.5); // Sun
            pointLight(0, 255, 255, noah.x, -50, noah.z); // Noah's blaster glow

            // 1. Draw Ground (Mars Surface)
            drawMarsTerrain();

            // 2. Draw The Rocket Ship (Center)
            drawRocket();

            // 3. Draw Hannah & James (The Objective)
            drawHannahAndJames();

            // 4. Draw Dad (NPC)
            drawDad();

            // 5. Draw Noah (Player)
            drawNoah();

            // 6. Draw Bullets
            drawBullets();

            // 7. Draw Aliens
            drawAliens();

            // 8. Draw Particles
            drawParticles();
        }

        function updateGame() {
            // Repair Progress
            repairProgress += 0.06; // Slow repair
            if (repairProgress >= 100) winGame();
            document.getElementById('repair-bar').style.width = Math.min(repairProgress, 100) + "%";

            // Movement (WASD) - Relative to world (X/Z plane)
            let speed = 6;
            if (keyIsDown(87)) noah.z -= speed; // W
            if (keyIsDown(83)) noah.z += speed; // S
            if (keyIsDown(65)) noah.x -= speed; // A
            if (keyIsDown(68)) noah.x += speed; // D

            // Noah Rotation (Look at Mouse)
            // Need to raycast mouse to ground plane, but simple approximation works for top-down
            let dx = mouseX - width / 2;
            let dy = mouseY - height / 2;
            noah.angle = Math.atan2(dy, dx) + HALF_PI; // Adjust for camera

            // Sword Swing Timer
            if (noah.swingTimer > 0) noah.swingTimer--;

            // Spawn Aliens
            if (frameCount % 60 === 0) spawnAlien();

            // Update Bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].x += Math.sin(bullets[i].angle) * 15;
                bullets[i].z += Math.cos(bullets[i].angle) * 15;
                bullets[i].life--;
                if (bullets[i].life <= 0) bullets.splice(i, 1);
            }

            // Update Aliens
            for (let i = aliens.length - 1; i >= 0; i--) {
                let a = aliens[i];
                // Move toward Center (0,0) where Hannah is
                let angleToCenter = Math.atan2(-a.x, -a.z); // Target 0,0
                a.x += Math.sin(angleToCenter) * a.speed;
                a.z += Math.cos(angleToCenter) * a.speed;

                // Collision: Bullet hits Alien
                for (let j = bullets.length - 1; j >= 0; j--) {
                    let b = bullets[j];
                    if (dist(a.x, a.z, b.x, b.z) < 30) {
                        createExplosion(a.x, a.z, 'green');
                        aliens.splice(i, 1);
                        bullets.splice(j, 1);
                        return;
                    }
                }

                // Collision: Sword hits Alien
                if (noah.swingTimer > 0 && dist(noah.x, noah.z, a.x, a.z) < 80) {
                    createExplosion(a.x, a.z, 'orange');
                    aliens.splice(i, 1);
                    return;
                }

                // Collision: Alien Reaches Hannah (Center)
                if (dist(a.x, a.z, 0, 0) < 60) {
                    hannahHealth -= 10;
                    createExplosion(0, 0, 'red');
                    aliens.splice(i, 1);
                    document.getElementById('hp-val').innerText = hannahHealth;
                    if (hannahHealth <= 0) loseGame();
                }
            }
        }

        // --- ACTIONS ---
        function mousePressed() {
            if (gameState === 'playing') {
                // Shoot Blaster
                bullets.push({
                    x: noah.x,
                    z: noah.z,
                    angle: -noah.angle + PI, // Correct angle for p5 geometry
                    life: 60
                });
            }
        }

        function keyPressed() {
            if (key === ' ' && gameState === 'playing') {
                noah.swingTimer = 15; // Sword active frames
            }

            // Mission 1 key handling
            if (gameState === 'm1_playing') {
                // E to interact
                if (key === 'e' || key === 'E') {
                    const interaction = checkM1Interactions();
                    if (interaction) {
                        if (interaction.type === 'neighbor' || interaction.type === 'house') {
                            showNeighborPrompt(interaction.data);
                        } else if (interaction.type === 'house_empty') {
                            showM1Notification(`${interaction.data.name} is at the lemonade stand!`, 2000);
                        } else if (interaction.type === 'house_angry') {
                            showM1Notification(`${interaction.data.name} won't answer... they're too annoyed!`, 2000);
                        } else if (interaction.type === 'shop') {
                            showShopPrompt();
                        } else if (interaction.type === 'lemonade_stand') {
                            if (m1CustomersWaiting > 0) {
                                showM1Notification(`Hannah: "I'm busy serving ${m1CustomersWaiting} customer${m1CustomersWaiting > 1 ? 's' : ''}!"`, 2000);
                            } else {
                                showM1Notification(`Hannah: "Send me some customers, Noah!"`, 2000);
                            }
                        }
                    }
                }

                // ESC to close prompts/shop
                if (keyCode === ESCAPE) {
                    if (m1IsShopOpen) {
                        closeShop();
                    } else if (m1ShowingPrompt) {
                        hidePrompt();
                    }
                }
            }
        }

        // --- DRAWING HELPERS ---

        function drawNoah() {
            push();
            translate(noah.x, -25, noah.z); // Raise slightly so he stands on ground
            rotateY(-noah.angle + PI); // Face mouse direction

            // Body
            fill(0, 0, 255); // Blue Shirt
            box(20, 30, 10);

            // Head (Blonde Boy)
            push();
            translate(0, -20, 0);
            fill(255, 220, 180); // Skin
            box(14);
            translate(0, -8, 0);
            fill(255, 255, 0); // Blonde Hair
            box(16, 6, 16);
            pop();

            // Right Arm (Holding Sword)
            push();
            translate(12, -5, 10);
            // Swing animation
            if (noah.swingTimer > 0) rotateX(map(noah.swingTimer, 0, 15, 0, -2));

            fill(0, 0, 200);
            box(6, 20, 6); // Arm

            // MINECRAFT SWORD
            translate(0, 10, 5);
            rotateX(PI/2);
            drawMinecraftSword();
            pop();

            // Left Arm (Holding Blaster)
            push();
            translate(-12, -5, 10);
            rotateX(-1.5); // Aim forward
            fill(0, 0, 200);
            box(6, 20, 6); // Arm
            translate(0, 15, 0);
            fill(50); // Gun Grey
            cylinder(3, 15);
            pop();

            pop();
        }

        function drawMinecraftSword() {
            // Pixelated look using small boxes
            fill(0, 255, 255); // Diamond Blue
            push();
            // Blade
            for(let i=0; i<5; i++) {
                translate(0, -4, 0);
                box(4);
            }
            // Guard
            translate(0, 20, 0);
            fill(100, 50, 0); // Wood handle color
            box(12, 4, 2);
            // Handle
            translate(0, 4, 0);
            box(4, 8, 2);
            pop();
        }

        function drawRocket() {
            push();
            translate(0, -150, -80);

            // Main body - white with segments
            fill(240, 240, 245);
            cylinder(35, 180);

            // Red stripe bands
            fill(200, 30, 30);
            push();
            translate(0, -60, 0);
            cylinder(36, 10);
            pop();
            push();
            translate(0, 30, 0);
            cylinder(36, 10);
            pop();

            // Upper section (narrower)
            push();
            translate(0, -100, 0);
            fill(240, 240, 245);
            cylinder(30, 40);
            pop();

            // Nose cone
            push();
            translate(0, -130, 0);
            fill(200, 30, 30);
            cone(30, 50);
            // Tip
            translate(0, -30, 0);
            fill(80);
            cone(8, 20);
            pop();

            // Window/Porthole
            push();
            translate(0, -50, 36);
            fill(50, 150, 255);
            sphere(12);
            // Window frame
            fill(80);
            torus(12, 2);
            pop();

            // Engine section (bottom)
            push();
            translate(0, 95, 0);
            fill(60);
            cylinder(38, 20);

            // Engine nozzles
            fill(40);
            translate(0, 15, 0);
            // Center nozzle
            push();
            cone(15, 25);
            fill(255, 100, 0, 150);
            translate(0, 15, 0);
            cone(12, 20); // Engine glow
            pop();

            // Side nozzles
            for (let i = 0; i < 3; i++) {
                push();
                rotateY(i * TWO_PI / 3);
                translate(22, 0, 0);
                fill(40);
                cone(8, 18);
                pop();
            }
            pop();

            // Fins (4 fins around the base)
            for (let i = 0; i < 4; i++) {
                push();
                rotateY(i * HALF_PI + QUARTER_PI);
                translate(35, 70, 0);
                rotateZ(-0.3);
                fill(200, 30, 30);
                // Fin shape using a box (simplified)
                box(5, 60, 30);
                // Fin tip
                translate(0, -35, 0);
                rotateZ(0.3);
                box(5, 30, 20);
                pop();
            }

            // Landing legs (3 legs)
            for (let i = 0; i < 3; i++) {
                push();
                rotateY(i * TWO_PI / 3);
                translate(30, 90, 0);
                rotateZ(-0.5);
                fill(80);
                box(6, 50, 6);
                // Foot pad
                translate(0, 28, 0);
                rotateZ(0.5);
                fill(60);
                cylinder(10, 4);
                pop();
            }

            pop();
        }

        function drawHannahAndJames() {
            push();
            translate(10, -15, 10);

            // Hannah (Pink dress)
            fill(255, 100, 150);
            box(12, 24, 12);

            // Head
            translate(0, -15, 0);
            fill(255, 220, 180);
            sphere(6);

            // Hannah's hair
            push();
            translate(0, -4, 0);
            fill(139, 69, 19); // Brown hair
            scale(1, 0.6, 1);
            sphere(7);
            pop();

            // James (Baby - Blue bundle held by Hannah)
            push();
            translate(8, 10, 5);
            // Blue blanket
            fill(135, 206, 250);
            sphere(6);
            // Baby face
            translate(0, -2, 4);
            fill(255, 220, 180);
            sphere(3);
            pop();

            // === HEALTH BAR ABOVE THEIR HEADS ===
            push();
            translate(-5, -30, 0);

            // Face toward the camera (fixed angle since camera is behind/above)
            rotateX(-0.3); // Tilt slightly toward camera

            // "Hannah & James" label
            push();
            translate(0, -12, 0);
            fill(255, 180, 220);
            textSize(7);
            textAlign(CENTER);
            text("Hannah & James", 0, 0);
            pop();

            // Health bar background (dark)
            fill(40, 40, 40);
            box(44, 5, 1);

            // Health bar border
            push();
            fill(100, 100, 100);
            translate(0, 0, -0.5);
            box(46, 7, 0.5);
            pop();

            // Health bar fill (green to yellow to red based on health)
            let healthWidth = (hannahHealth / 100) * 42;
            let r = hannahHealth < 50 ? 255 : map(hannahHealth, 50, 100, 255, 0);
            let g = hannahHealth > 50 ? 255 : map(hannahHealth, 0, 50, 0, 255);
            fill(r, g, 0);

            // Offset to left-align the health bar fill
            push();
            translate(-21 + healthWidth / 2, 0, 0.5);
            box(healthWidth, 4, 1);
            pop();

            // Health percentage text
            push();
            translate(0, 8, 0);
            fill(255);
            textSize(6);
            textAlign(CENTER);
            text(hannahHealth + "% HP", 0, 0);
            pop();

            pop(); // End health bar

            pop(); // End Hannah and James
        }

        function drawDad() {
            push();
            translate(-40, -25, -60);
            // Dad fixing animation
            if (frameCount % 20 < 10) translate(0, -2, 0);

            fill(50, 50, 200); // Dad Clothes
            box(20, 50, 20);
            // Head
            translate(0, -30, 0);
            fill(255, 200, 150);
            sphere(10);

            // Text Bubble
            translate(0, -30, 0);
            rotateY(PI); // Face camera
            fill(255);
            textSize(12);
            textAlign(CENTER);
            if (frameCount % 120 < 60) text("Almost fixed!", 0, 0);
            pop();
        }

        function drawAliens() {
            aliens.forEach(a => {
                push();
                translate(a.x, 0, a.z);

                // Face toward the rocket (center 0,0)
                let angleToCenter = Math.atan2(-a.x, -a.z);
                rotateY(angleToCenter);

                // Walking bounce and cycle
                let walkCycle = frameCount * 0.15 + (a.walkOffset || 0);
                let bounce = Math.abs(Math.sin(walkCycle)) * 4;
                translate(0, -bounce, 0);

                // Slight body sway while walking
                rotateZ(Math.sin(walkCycle) * 0.08);

                // === LEGS ===
                let legSwing = Math.sin(walkCycle) * 0.5;

                // Left leg
                push();
                translate(-5, -3, 0);
                rotateX(legSwing);
                fill(0, 180, 0);
                // Thigh
                push();
                translate(0, 6, 0);
                box(4, 12, 4);
                // Shin
                translate(0, 9, 0);
                rotateX(-Math.abs(legSwing) * 0.4);
                fill(0, 160, 0);
                box(3, 10, 3);
                // Foot
                translate(0, 7, 2);
                fill(0, 140, 0);
                box(4, 2, 7);
                pop();
                pop();

                // Right leg
                push();
                translate(5, -3, 0);
                rotateX(-legSwing);
                fill(0, 180, 0);
                push();
                translate(0, 6, 0);
                box(4, 12, 4);
                translate(0, 9, 0);
                rotateX(-Math.abs(-legSwing) * 0.4);
                fill(0, 160, 0);
                box(3, 10, 3);
                translate(0, 7, 2);
                fill(0, 140, 0);
                box(4, 2, 7);
                pop();
                pop();

                // === BODY ===
                push();
                translate(0, -12, 0);
                fill(0, 220, 0);
                scale(1, 1.1, 0.8);
                sphere(8);
                pop();

                // === ARMS ===
                let armSwing = Math.sin(walkCycle + PI) * 0.4;

                // Left arm
                push();
                translate(-10, -14, 0);
                rotateX(armSwing);
                rotateZ(0.2);
                fill(0, 180, 0);
                box(3, 12, 3);
                // Claw hand
                translate(0, 8, 0);
                fill(0, 140, 0);
                sphere(2.5);
                // Three fingers
                for (let f = -1; f <= 1; f++) {
                    push();
                    rotateZ(f * 0.3);
                    translate(0, 3, 0);
                    box(1, 4, 1);
                    pop();
                }
                pop();

                // Right arm
                push();
                translate(10, -14, 0);
                rotateX(-armSwing);
                rotateZ(-0.2);
                fill(0, 180, 0);
                box(3, 12, 3);
                translate(0, 8, 0);
                fill(0, 140, 0);
                sphere(2.5);
                for (let f = -1; f <= 1; f++) {
                    push();
                    rotateZ(f * 0.3);
                    translate(0, 3, 0);
                    box(1, 4, 1);
                    pop();
                }
                pop();

                // === BIG HEAD ===
                push();
                translate(0, -32, 0);

                // Neck
                push();
                translate(0, 8, 0);
                fill(0, 180, 0);
                cylinder(2.5, 6);
                pop();

                // Main head (oversized!)
                fill(0, 255, 0);
                push();
                scale(1.2, 1, 1);
                sphere(14);
                pop();

                // Forehead bulge (big brain!)
                push();
                translate(0, -5, 2);
                fill(0, 240, 0);
                scale(1, 0.6, 0.7);
                sphere(12);
                pop();

                // === EYES (big and creepy) ===
                push();
                translate(0, 2, 10);

                // Left eye
                push();
                translate(-5, 0, 0);
                // Eye white/glow
                fill(200, 255, 200);
                scale(1.2, 1.4, 0.6);
                sphere(4);
                pop();
                // Left pupil
                push();
                translate(-5, 0, 4);
                fill(0, 0, 0);
                sphere(2);
                // Eye shine
                translate(0.5, -0.5, 1);
                fill(255);
                sphere(0.7);
                pop();

                // Right eye
                push();
                translate(5, 0, 0);
                fill(200, 255, 200);
                scale(1.2, 1.4, 0.6);
                sphere(4);
                pop();
                push();
                translate(5, 0, 4);
                fill(0, 0, 0);
                sphere(2);
                translate(-0.5, -0.5, 1);
                fill(255);
                sphere(0.7);
                pop();

                pop(); // End eyes

                // Mouth (sinister grin)
                push();
                translate(0, 8, 12);
                fill(0, 100, 0);
                scale(1.5, 0.4, 0.3);
                sphere(4);
                pop();

                // === ANTENNAS ===
                // Left antenna
                push();
                translate(-6, -12, 0);
                rotateZ(0.3);
                rotateX(-0.2);
                fill(0, 160, 0);
                cylinder(1, 12);
                // Glowing tip
                translate(0, -7, 0);
                fill(255, 50, 255);
                sphere(2.5);
                // Glow effect
                fill(255, 100, 255, 100);
                sphere(4);
                pop();

                // Right antenna
                push();
                translate(6, -12, 0);
                rotateZ(-0.3);
                rotateX(-0.2);
                fill(0, 160, 0);
                cylinder(1, 12);
                translate(0, -7, 0);
                fill(255, 50, 255);
                sphere(2.5);
                fill(255, 100, 255, 100);
                sphere(4);
                pop();

                pop(); // End head

                pop(); // End alien
            });
        }

        function drawBullets() {
            fill(0, 255, 255);
            bullets.forEach(b => {
                push();
                translate(b.x, -30, b.z);
                sphere(3);
                pop();
            });
        }

        function spawnAlien() {
            // Spawn at edge of a circle radius 500
            let angle = random(TWO_PI);
            let r = 500;
            aliens.push({
                x: cos(angle) * r,
                z: sin(angle) * r,
                speed: 1.5 + (repairProgress / 50), // Get faster as repair finishes
                walkOffset: random(TWO_PI) // Random walk cycle offset
            });
        }

        function createExplosion(x, z, color) {
            // Simple particle burst
            for(let i=0; i<5; i++) {
                particles.push({
                    x: x, z: z, y: -20,
                    vx: random(-2, 2), vy: random(-5, -2), vz: random(-2, 2),
                    life: 20, color: color
                });
            }
        }

        function drawParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                push();
                translate(p.x, p.y, p.z);
                fill(p.color);
                box(5);
                pop();
                p.x += p.vx;
                p.y += p.vy;
                p.z += p.vz;
                p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        // --- GAME STATES ---
        function winGame() {
            gameState = "won";
            document.getElementById('ui-layer').style.opacity = '0';
            document.getElementById('victory-cutscene').style.display = 'flex';

            // Save mission 3 as completed
            saveProgress(3);
        }

        function loseGame() {
            gameState = "lost";
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('ov-title').innerText = "GAME OVER";
            document.getElementById('ov-title').style.color = "red";
            document.getElementById('ov-desc').innerText = "The aliens captured Hannah and James.";
        }

        function resetGame() {
            // Clear any existing intro timeout
            if (introTimeout) clearTimeout(introTimeout);

            gameState = "intro";
            repairProgress = 0;
            hannahHealth = 100;
            noah.x = 0; noah.z = 0;
            aliens = [];
            bullets = [];
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('victory-cutscene').style.display = 'none';
            document.getElementById('hp-val').innerText = "100";
            document.getElementById('ui-layer').style.opacity = '0';
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('mission-intro').style.display = 'flex';
            document.getElementById('cutscene').style.display = 'none';

            // Reset victory cutscene animations by removing and re-adding elements
            const victoryCutscene = document.getElementById('victory-cutscene');
            const victoryHTML = victoryCutscene.innerHTML;
            victoryCutscene.innerHTML = victoryHTML;

            // Set up auto-advance timer again
            introTimeout = setTimeout(() => {
                if (gameState === "intro") {
                    document.getElementById('mission-intro').style.display = 'none';
                    document.getElementById('cutscene').style.display = 'flex';
                    gameState = "cutscene";
                }
            }, 3000);
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }
    </script>
</body>
</html>
